<!DOCTYPE html>
<!-- DESIGN FREEZE: Layout and styling locked as of 2025-09-08 (v1.0). Do not alter structure/visuals unless Wade explicitly requests. -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="x-design-version" content="v1.0-2025-09-08" />
  <title>Leicester Gallowtree Gate â€“ Package Builder / One Pager.</title>
  <style>
    :root{ --bg:#ECE4D8; --panel:#F6EEE3; --muted:#5b534a; --ink:#1a1917; --primary:#2f2a25; --primaryText:#fffaf5; --border:#E0D6C8; --accent:#ff7a59; --red:#d92d20; --amber:#b7791f; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); font-size:16px; }
    html, body{ max-width:100%; overflow-x:hidden }
    header{position:static;top:auto;z-index:5;background:var(--panel);border-bottom:1px solid var(--border)}
    .bar{max-width:1842px;margin:auto;padding:14px 18px;display:flex;gap:12px;align-items:center}
    .ver{margin-left:8px;color:var(--muted);font-size:12px}
    h1{color:var(--ink);font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}

    .wrap{max-width:1842px;margin:16px auto;padding:0 18px;display:grid;grid-template-columns:1fr 340px;gap:16px}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}

    .filters,.catalog,.cart{background:var(--panel);border:1px solid var(--border);border-radius:12px}
    .filters{padding:14px; grid-column:1;}
    .filters h2{font-size:14px;color:var(--ink);margin:0 0 8px}
    .filters label{color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    select,input[type="search"]{background:var(--panel);border:1px solid var(--border);color:var(--ink);padding:10px 12px;border-radius:10px;min-width:160px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#f3eee6;color:var(--ink);padding:8px 10px;border-radius:999px;cursor:pointer;font-size:12px}
    .chip-accent{background:var(--accent);color:#fff;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600}
    #overridesBadge {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 6px;
}
    #pinnedBadge { font-size: 11px; padding: 2px 6px; border-radius: 6px }
    
    /* Pinned packages */
    .pinned{background:#fdf8f5;border:1px solid var(--border);border-radius:12px;padding:12px 12px;margin-top:12px;box-shadow:0 2px 8px rgba(0,0,0,0.03);border-left:8px solid var(--accent); grid-column:1}
    .pinned h2{font-size:14px;color:var(--ink);margin:0 0 8px;display:flex;align-items:center;gap:8px}
    .pinned .actions{margin-left:auto;display:flex;gap:8px}
    .pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:1060px){.pgrid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.pgrid{grid-template-columns:1fr}}
    .pcard{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:6px}
    .pcard:hover{box-shadow:0 2px 12px rgba(0,0,0,0.08);transform:translateY(-2px)}
    .pcard .ptitle{font-weight:700;color:var(--ink);font-size:13px}
    .plist{color:var(--muted);font-size:12px;line-height:1.35}
    .prow{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
    .ptotal{font-weight:800;color:var(--primary)}
    .pcard .del{display:none;margin-left:6px;border:none;background:transparent;cursor:pointer;color:var(--muted);font-size:14px}
    .pcard .top{display:flex;align-items:center;justify-content:space-between}
    .btn.sm{padding:6px 8px;font-size:12px;border-radius:8px}
    .pedit{display:none;margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
    .pedit .hint{color:var(--muted);font-size:12px;margin-bottom:6px}
    .pedit textarea{width:100%;min-height:140px;border:1px solid var(--border);border-radius:8px;background:var(--panel);color:var(--ink);padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
    .pedit .row{display:flex;gap:8px;margin-top:8px}

    .catalog{padding:12px; grid-column:1;}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:1060px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}

    /* Two-up cards on mobile / small tablets */
    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
      .grid{ gap:8px }
    }
    /* Keep two-up even on very small phones */
    @media (max-width: 420px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }

    .card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; cursor:pointer; transition:box-shadow .12s, transform .05s; }
    .card:hover{ box-shadow:0 2px 10px rgba(0,0,0,.05);}
    .details{
      background:var(--panel);
      border-radius:14px;
      padding:20px 18px;
      margin-top:18px;
      color:var(--ink);
      border:1px solid #ddd;
      box-shadow:0 2px 8px 0 rgba(0,0,0,0.03);
      display:none;
      grid-column:1;
    }
    .details h2{
      margin-top:0;
      font-size:18px;
      color:var(--ink);
    }
    .details ul{
      margin:8px 0 0 18px;
      padding:0;
      color:var(--muted);
      font-size:14px;
    }
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#faf3eb;color:#2b2622}
    .tag.teal{border-color:#ffe2d6;color:#b94a32;background:#fff0ea}
    .tag.half{border-color:#e6d4b8;background:#f7ecd9;color:#6b4f2a}
    .card h3{color:var(--ink);margin:0;font-size:15px;line-height:1.2}
    .price{color:var(--primary);font-weight:800;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .features{display:flex;flex-direction:column;gap:4px;color:var(--muted);font-size:12px;margin-top:6px}
    .btn{background:var(--primary);border:1px solid var(--primary);color:var(--primaryText);font-weight:700;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn:focus{outline:2px solid var(--accent);outline-offset:2px}
    .btn.sec{background:#fff;border:1px solid var(--border);color:var(--ink)}
    .btn.danger{background:var(--red);border:1px solid var(--red);color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .cart{padding:14px;position:sticky;top:74px;align-self:start; grid-column:2;}
    .cart h2{margin:0 0 10px;color:var(--ink);font-size:16px}
    .cart .item{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;border-top:1px dashed #2a365b;padding-top:10px;margin-top:10px}
    .cart .item .name{color:var(--ink);font-size:13px}
    .cart .item .note{color:var(--amber);font-size:11px}
    .total{display:flex;justify-content:space-between;border-top:2px solid var(--border);margin-top:12px;padding-top:12px;color:var(--ink);font-weight:800}
    .rule{font-size:12px;color:var(--muted);margin-top:10px}

    .admin-bar{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .admin-on{color:var(--amber);font-size:12px}
    .editable{border:1px dashed var(--amber);background:#fff;color:var(--ink)}

    .mbar{ display:none }
    /* Mobile optimisations */
    @media (max-width: 760px){
      .wrap{grid-template-columns:1fr; padding:0 12px}
      .filters{grid-column:1}
      .pinned{grid-column:1}
      .details{grid-column:1}
      .catalog{grid-column:1}
      .cart{grid-column:1; position:static; top:auto;}

      .grid{grid-template-columns:repeat(2,1fr); gap:8px}
      .pgrid{grid-template-columns:1fr}

      /* Make filter controls stack nicely */
      .row{gap:6px}
      .row > *{flex:1 1 100%; min-width:0}
      select, input[type="search"]{width:100% !important; min-width:0}

      /* Touch-friendly controls */
      .btn{padding:12px}
      .btn.sm, .btn.sec.sm{padding:8px 10px}
      .card{padding:12px}
      header .row{gap:8px}

      /* Header wraps to avoid forcing page width */
      header .bar{ flex-wrap:wrap }
      header .bar .row{ width:100%; flex-wrap:wrap; gap:6px }
      /* Smaller header on mobile */
      header .bar{ padding:6px 10px }
      header h1{ font-size:14px }
      header .ver{ display:none }
      header .row .btn{ padding:8px 10px; font-size:12px }

      /* Tiny sticky footer bar on mobile */
      .mbar{ display:flex; position:fixed; bottom:0; left:0; right:0; background:var(--panel); border-top:1px solid var(--border); padding:8px 10px; align-items:center; gap:10px; z-index:10 }
      .mbar .tot{ display:flex; flex-direction:column; font-size:12px; line-height:1.2 }
      .mbar .tot b{ font-size:13px }
      .mbar .spacer{ flex:1 }
      .mbar .btn{ min-height:36px }
      body{ padding-bottom:64px } /* avoid content underlap */
      .filters{ padding:8px }
      .filters h2{ font-size:13px; margin-bottom:4px }
      .filters .row{ gap:6px; margin-bottom:6px !important }
      .filters select, .filters input[type="search"]{ padding:8px 10px; min-width:0 }
      .chip{ padding:6px 8px; font-size:11px }
      .filters .muted{ font-size:11px; display:none } /* hide helper tip on mobile to save space */

      /* Extraâ€‘compact cards */
      .card{ padding:8px }
      .card h3{ font-size:13px; white-space:normal; overflow:hidden }
      .muted{ font-size:11px }
      .price{ font-size:18px }
      .tag{ font-size:10px; padding:2px 6px }
      .card div[style*="margin-top:auto"] .btn{ min-height:36px; font-size:12px }

      /* Extraâ€‘compact filters */
      .filters{ padding:6px }
      .filters h2{ font-size:12px; margin-bottom:2px }
      .filters .row{ gap:4px; margin-bottom:4px !important }
      .filters select, .filters input[type="search"]{ padding:6px 8px; min-width:0 }
      .chip{ padding:4px 6px; font-size:10px }

      /* ===== Ultra-compact mobile mode ===== */
      body{ font-size:14px }

      /* Header shrink */
      header .bar{ padding:4px 8px }
      header h1{ font-size:12px }
      header .row .btn{ padding:6px 8px; font-size:11px }

      /* Filters tighter */
      .filters{ padding:4px }
      .filters h2{ font-size:11px; margin-bottom:2px }
      .filters .row{ gap:4px; margin-bottom:4px !important }
      .filters select, .filters input[type="search"]{ padding:6px 8px; min-width:0 }
      .chip{ padding:3px 6px; font-size:10px }

      /* Cards: two-up tiny, readable */
      .grid{ gap:6px }
      .card{ padding:6px }
      .card h3{ font-size:12px; line-height:1.2; white-space:normal; overflow:hidden }
      .muted{ font-size:10.5px }
      .price{ font-size:16px }
      .tag{ font-size:9px; padding:1px 5px }
      .card div[style*="margin-top:auto"] .btn{ min-height:32px; font-size:11px; padding:6px 8px }
      /* Hide the small meta line to save height */
      .card > .muted{ display:none }

      /* Cart compaction */
      .cart{ padding:10px }
      .cart h2{ font-size:14px }
      .cart .item{ gap:6px }
      .cart .item .name{ font-size:12px }
      .cart .item .note{ font-size:10px }
      .cart input[type="number"]{ width:50px; height:36px }
      .total{ font-size:14px }
      .rule{ font-size:11px }

      /* Sticky footer: smaller */
      .mbar{ padding:6px 8px }
      .mbar .tot{ font-size:11px }
      .mbar .tot b{ font-size:12px }
      .mbar .btn{ min-height:32px }
    }
    /* Show sticky footer on small screens incl. big iPhones */
    @media (max-width: 900px){
      .mbar{ display:flex }
      body{ padding-bottom: calc(64px + env(safe-area-inset-bottom, 0px)) }
      .mbar{ padding-bottom: env(safe-area-inset-bottom, 0px); z-index: 999 }
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>Leicester Gallowtree Gate â€¢ Package Builder / One Pager.</h1>
      <span id="lastUpdated" class="ver" style="display:inline-block">â€¢ last updated â€¦</span>
      <span id="overridesBadge" class="chip-accent" style="display:none">Overrides active</span>
      <span id="pinnedBadge" class="chip-accent" style="display:none">Pinned active</span>
      <div class="row" style="margin-left:auto">
        <button id="loginBtn" class="btn sec">Muhammad/Wade/Karin</button>
        <button id="clearBtn" class="btn sec">Clear package</button>
        <button id="exportBtn" class="btn">Export package</button>
        <button id="exportOverridesBtn" class="btn sec" style="display:none" title="Download overrides.json for GitHub">Export overrides</button>
        <button id="reloadOverridesBtn" class="btn sec" style="display:none" title="Reload overrides.json">Reload overrides</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="filters">
      <h2>Filters <button id="toggleFilters" class="btn sec sm" style="margin-left:8px">â–²</button></h2>
      <div id="filtersBody">
        <div class="row" style="margin-bottom:8px">
          <input id="q" type="search" placeholder="Search e.g. 120GB, Lite, Unlimitedâ€¦" />
          <select id="tier">
            <option value="">All tiers</option>
            <option>Lite</option>
            <option>Value</option>
            <option>Complete</option>
          </select>
          <select id="data">
            <option value="">All data</option>
            <option>25GB</option>
            <option>120GB</option>
            <option>160GB</option>
            <option>250GB</option>
            <option>Unlimited</option>
          </select>
          <label class="chip"><input id="flagX" type="checkbox" /> Crossâ€‘sell (X)</label>
          <label class="chip"><input id="flagS" type="checkbox" /> Student (S)</label>
          <label class="chip"><input id="flagMulti" type="checkbox" /> Multiâ€‘SIM</label>
          <select id="introSel" title="Intro half-price">
  <option value="">Intro price: Any</option>
  <option value="6">6 months</option>
  <option value="9">9 months</option>
  <option value="12">12 months</option>
</select>
        </div>
        <div class="muted">Tip: Click a plan to add it to the package. Multiâ€‘SIM requires a base plan in the package with <b>same or higher data</b>. Crossâ€‘sell (X) requires a base plan too.</div>
        <div class="admin-bar"><span id="adminState" class="admin-on" style="display:none">Admin mode: prices editable</span></div>
      </div>
    </section>

    <section class="pinned" id="pinnedSection">
      <h2>ðŸ“Œ Packages to Push <span style="color:var(--muted);font-weight:600">(quick adds)</span>
        <span class="chip-accent">Recommended</span>
        <button id="togglePinned" class="btn sec sm" style="margin-left:8px">â–¼</button>
        <span class="actions">
          <button id="editPinnedBtn" class="btn sec sm" style="display:none">Edit</button>
          <button id="newPinnedFromCart" class="btn sm" style="display:none">Pin cart</button>
          <button id="exportPinnedJson" class="btn sec sm" style="display:none" title="Download pinned.json for GitHub">Export JSON</button>
        </span>
      </h2>
      <div id="pinned" class="pgrid"></div>
      <div id="pinnedEditor" class="pedit">
        <div class="hint">Admin-only. Edit JSON, then Save. Structure: <code>[{ title, items:[{ name, qty }] }]</code></div>
        <textarea id="pinnedTextarea"></textarea>
        <div class="row">
          <button id="pinnedSave" class="btn sm">Save</button>
          <button id="pinnedCancel" class="btn sec sm">Cancel</button>
          <button id="pinnedReset" class="btn sec sm" title="Reset to defaults">Reset</button>
        </div>
      </div>
    </section>

    <section class="details"><h2>Plan Details</h2><div id="details"></div></section>

    <section class="catalog">
      <div id="grid" class="grid"></div>
    </section>

    <aside class="cart">
      <h2>Selected Package</h2>
      <div id="cartList"></div>
      <div class="total" id="rowFirst6"><span id="labelFirst6">Months 1â€“6 per month</span><span id="grandFirst6">Â£0.00</span></div>
      <div class="total" id="rowLater"><span id="labelLater">Months 7â€“24 per month</span><span id="grandLater">Â£0.00</span></div>
      <div class="rule">Rules enforced: (1) Multiâ€‘SIM must be â‰¤ highest data in package. (2) Crossâ€‘sell/X requires at least one nonâ€‘Multi, nonâ€‘X base plan.</div>
    </aside>
    <div class="mbar" id="mobileBar">
      <div class="tot"><span>1â€“6m</span><b id="mFirst6">Â£0.00</b></div>
      <div class="tot"><span>7â€“24m</span><b id="mLater">Â£0.00</b></div>
      <div class="spacer"></div>
      <button class="btn" id="mScrollCart">Scroll to cart</button>
    </div>
  </div>

  <script>
  // â€”â€”â€” Data â€”â€”â€”
  // NOTE: You can edit prices live in Admin mode, and they persist in localStorage.
  const ADMIN_PASS = "1842"; // change this to your preferred password
  const DESIGN_VERSION = "v1.0-2025-09-08"; // Design freeze identifier

  // Curated packages to promote (edit titles or items as needed)
  let PINNED = [
    {
      title: 'Push: Unlimited Lite',
      items: [ { name: 'Unlimited Lite SIMO 24M', qty: 1 } ]
    },
    {
      title: 'Push: 160GB Value + Multi 160GB',
      items: [
        { name: '160GB Value SIMO 24M', qty: 1 },
        { name: '160GB Lite SIMO Multi SIM 24M', qty: 1 }
      ]
    },
    {
      title: 'Push: 250GB Value',
      items: [ { name: '250GB Value SIMO 24M', qty: 1 } ]
    }
  ];
  // Load saved pinned packages if present
  try{
    const savedPinned = JSON.parse(localStorage.getItem('pinnedPackages')||'null');
    if(Array.isArray(savedPinned)) PINNED = savedPinned;
  }catch{ /* ignore parse errors */ }

  // Try to load shared pinned packages from pinned.json at site root (if repo includes it)
  async function loadPinnedFromJSON(){
    try{
      const resp = await fetch('./pinned.json', {cache:'no-store'});
      if(!resp.ok) return; // no shared file present
      const data = await resp.json();
      if(Array.isArray(data)){
        PINNED = data;
        const pb = document.getElementById('pinnedBadge'); if(pb) pb.style.display='inline-block';
        renderPinned();
      }
    }catch(e){ /* ignore if not present */ }
  }
  loadPinnedFromJSON();

  // Load shared price/flag overrides if overrides.json exists at root
  async function loadOverridesFromJSON(){
    try{
      const resp = await fetch(`./overrides.json?v=${Date.now()}`, {cache:'no-store'});
      if(!resp.ok) return; // no shared overrides file present
      const data = await resp.json();
      const stats = applyOverrides(data);
      // Show badge with stats
      const badge=document.getElementById('overridesBadge');
      if(badge){
        badge.style.display='inline-block';
        badge.textContent = `Overrides active (${stats.priceUpdates} prices, ${stats.introUpdates} intro)`;
      }
      render();
    }catch(e){ console.warn('overrides.json not loaded', e); }
  }
function applyOverrides(data){
  let priceUpdates = 0, introUpdates = 0;
  const missingNames = [];
  if(data && data.pricesByName){
    for(const [name,price] of Object.entries(data.pricesByName)){
      const p = plans.find(x=>x.name===name);
      if(p && typeof price==='number') { p.price = price; priceUpdates++; }
      else { missingNames.push(name); }
    }
  }
  // New: explicit intro months map (6/9/12)
  if(data && data.introMonthsByName){
    for(const [name,months] of Object.entries(data.introMonthsByName)){
      const p = plans.find(x=>x.name===name);
      const m = Number(months);
      if(p && (m===6 || m===9 || m===12)) { p.introMonths = m; introUpdates++; }
    }
  }
  // Legacy fallback: half6Names => introMonths=6
  if(data && Array.isArray(data.half6Names)){
    for(const name of data.half6Names){
      const p = plans.find(x=>x.name===name);
      if(p){ if(!p.introMonths) introUpdates++; p.introMonths = 6; }
    }
  }
  if(missingNames.length){
    console.warn('Overrides: no plan matches for', missingNames);
  }
  return { priceUpdates, introUpdates };
}
  loadOverridesFromJSON();

  function savePinned(){ localStorage.setItem('pinnedPackages', JSON.stringify(PINNED)); }

function packageTotal(pkg){
    let total = 0;
    for(const it of pkg.items){
      const p = plans.find(x=>x.name===it.name);
      if(p){
        const qty = it.qty||1;
        const base = p.price * qty; // stored price = half price when p.half6
        total += (p.introMonths>0) ? (base*2) : base; // later months use double if half6
      }
    }
    return total;
}

function packageFirst6(pkg){
    let total = 0;
    for(const it of pkg.items){
      const p = plans.find(x=>x.name===it.name);
      if(p){
        const qty = it.qty||1;
        const base = p.price * qty; // first 6 months use the stored (half) price if half6
        total += base;
      }
    }
    return total;
}

  function addPinnedToCart(pkg){
    for(const it of pkg.items){
      const p = plans.find(x=>x.name===it.name);
      if(!p){ alert(`Plan not found: ${it.name}`); continue; }
      const check = canAdd(p);
      if(!check.allowed){ alert(check.reason); return; }
      const existing = packageItems.find(x=>x.id===p.id);
      const qty = it.qty||1;
      if(existing) existing.qty += qty; else packageItems.push({id:p.id,name:p.name,price:p.price,qty, note:noteFor(p)});
    }
    render();
  }

  function renderPinned(){
    const wrap = document.getElementById('pinned');
    if(!wrap) return;
    wrap.innerHTML = '';
    PINNED.forEach((pkg, idx)=>{
      const div = document.createElement('div');
      div.className = 'pcard';
      const lines = pkg.items.map(it=>`${it.qty||1}Ã— ${it.name}`).join('<br>');
      const later = packageTotal(pkg).toFixed(2);
      const first6 = packageFirst6(pkg).toFixed(2);
      const maxIntro = Math.max(0, ...pkg.items.map(it=>{ const pp = plans.find(x=>x.name===it.name); return pp && pp.introMonths ? pp.introMonths : 0; }));
      div.innerHTML = `
        <div class="top">
          <div class="ptitle">${pkg.title}</div>
          <button class="del" title="Remove">âœ•</button>
        </div>
        <div class="plist">${lines}</div>
        <div class="prow">
          <div class="ptotal">
            <div class="ptotal">
  <div style="font-weight:800;color:var(--accent)">${maxIntro>0?`1â€“${maxIntro}m`:'Total'}: Â£${first6}</div>
  ${maxIntro>0?`<div class="muted" style="font-size:12px">${maxIntro+1}â€“24m: Â£${later}</div>`:''}
</div>
          <button class="btn">Add package</button>
        </div>`;
      div.querySelector('.btn').addEventListener('click',()=>addPinnedToCart(pkg));
      const delBtn = div.querySelector('.del');
      if(admin){ delBtn.style.display='inline'; }
      delBtn.addEventListener('click', (e)=>{ e.stopPropagation(); PINNED.splice(idx,1); savePinned(); renderPinned(); });
      wrap.appendChild(div);
    });
  }
  function bindPinnedToggle(){
    const btn = document.getElementById('togglePinned');
    const grid = document.getElementById('pinned');
    if(!btn || !grid) return;
    btn.onclick = ()=>{
      const isHidden = grid.style.display==='none';
      grid.style.display = isHidden? 'grid':'none';
      btn.textContent = isHidden? 'â–¼':'â–²';
    };
  }

  function openPinnedEditor(){
    const ed = document.getElementById('pinnedEditor');
    const ta = document.getElementById('pinnedTextarea');
    ta.value = JSON.stringify(PINNED, null, 2);
    ed.style.display = 'block';
  }
  function closePinnedEditor(){
    const ed = document.getElementById('pinnedEditor');
    ed.style.display = 'none';
  }
  function bindPinnedEditor(){
    const btn = document.getElementById('editPinnedBtn');
    const save = document.getElementById('pinnedSave');
    const cancel = document.getElementById('pinnedCancel');
    const reset = document.getElementById('pinnedReset');
    if(btn){ btn.onclick = ()=>openPinnedEditor(); }
    if(cancel){ cancel.onclick = ()=>closePinnedEditor(); }
    if(reset){ reset.onclick = ()=>{ localStorage.removeItem('pinnedPackages'); closePinnedEditor(); } }
    if(save){
      save.onclick = ()=>{
        try{
          const ta = document.getElementById('pinnedTextarea');
          const parsed = JSON.parse(ta.value);
          if(!Array.isArray(parsed)) throw new Error('Expected an array');
          for(const pkg of parsed){
            if(typeof pkg.title!== 'string' || !Array.isArray(pkg.items)) throw new Error('Each package needs a title and items[]');
          }
          PINNED = parsed;
          savePinned();
          renderPinned();
          closePinnedEditor();
        }catch(err){ alert('Invalid JSON: '+ err.message); }
      };
    }
  }

  function bindPinFromCart(){
    const btn = document.getElementById('newPinnedFromCart');
    if(!btn) return;
    btn.onclick = ()=>{
      if(!packageItems.length){ alert('Cart is empty. Add some tariffs first, then pin.'); return; }
      const title = prompt('Package title');
      if(title===null) return;
      const items = packageItems.map(it=>({ name: it.name, qty: it.qty }));
      PINNED.unshift({ title: title || 'Pinned package', items });
      savePinned();
      renderPinned();
    };
  }

  function bindExportPinned(){
    const btn = document.getElementById('exportPinnedJson');
    if(!btn) return;
    btn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(PINNED, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'pinned.json'; a.click();
      URL.revokeObjectURL(url);
    };
  }

  const plans = [
    // 25GB
    P({name:"25GB Lite SIMO 24M", tier:"Lite", data:"25GB", price:7.00, inc:["Â£14.00 from Mar26","Â£15.25 from Apr26","Â£16.50 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"25GB Value SIMO 24M", tier:"Value", data:"25GB", price:9.50, inc:["Â£10.12 from Apr26","Â£20.25 from Jun26","Â£21.50 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"25GB Complete SIMO 24M", tier:"Complete", data:"25GB", price:12.00, inc:["Â£12.62 from Apr26","Â£25.25 from Sep26","Â£26.50 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),

    // 120GB
    P({name:"120GB Lite SIMO 24M", tier:"Lite", data:"120GB", price:8.00, inc:["Â£16.00 from Mar26","Â£17.50 from Apr26","Â£19.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"120GB Value SIMO 24M", tier:"Value", data:"120GB", price:10.50, inc:["Â£11.25 from Apr26","Â£22.50 from Jun26","Â£24.00 from Apr27"], features:["Three+ Rewards","5G at no extra cost","Paramount+: 12m inclusive","Go Roam â€“ Check plan details"]}),
    P({name:"120GB Complete SIMO 24M", tier:"Complete", data:"120GB", price:13.00, inc:["Â£13.75 from Apr26","Â£27.50 from Sep26","Â£29.00 from Apr27"], features:["5G at no extra cost","Go Roam â€“ Check plan details","Three+ Rewards","Paramount+: 24m inclusive"]}),

    // 160GB main
    P({name:"160GB Lite SIMO 24M", tier:"Lite", data:"160GB", price:22.00, inc:["Â£23.50 from Apr26","Â£25.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Value SIMO 24M", tier:"Value", data:"160GB", price:27.00, inc:["Â£28.50 from Apr26","Â£30.00 from Apr27"], features:["Three+ Rewards","5G at no extra cost","Paramount+: 12m inclusive","Go Roam â€“ Check plan details"]}),
    P({name:"160GB Complete SIMO 24M", tier:"Complete", data:"160GB", price:32.00, inc:["Â£33.50 from Apr26","Â£35.00 from Apr27"], features:["5G at no extra cost","Go Roam â€“ Check plan details","Three+ Rewards","Paramount+: 24m inclusive"]}),

    // 160GB variants (X / Multi)
    P({name:"160GB Value SIMO 24M X", tier:"Value", data:"160GB", price:16.80, x:true, inc:["Â£18.30 from Apr26","Â£19.80 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Complete SIMO Multi SIM 24M", tier:"Complete", data:"160GB", price:20.00, multi:true, inc:["Â£21.50 from Apr26","Â£23.00 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Complete SIMO 24M X", tier:"Complete", data:"160GB", price:20.80, x:true, inc:["Â£22.30 from Apr26","Â£23.80 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Lite SIMO Multi SIM 24M", tier:"Lite", data:"160GB", price:10.00, multi:true, inc:["Â£11.50 from Apr26","Â£13.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Lite SIMO 24M X", tier:"Lite", data:"160GB", price:12.80, x:true, inc:["Â£14.30 from Apr26","Â£15.80 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Value SIMO Multi SIM 24M", tier:"Value", data:"160GB", price:15.00, multi:true, inc:["Â£16.50 from Apr26","Â£18.00 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),

    // 250GB
    P({name:"250GB Complete SIMO 24M", tier:"Complete", data:"250GB", price:16.00, inc:["Â£16.75 from Apr26","Â£33.50 from Sep26","Â£35.00 from Apr27"], features:["Three+ Rewards","Go Roam â€“ Check plan details","Paramount+: 24m inclusive","5G at no extra cost"]}),
    P({name:"250GB Lite SIMO 24M X", tier:"Lite", data:"250GB", price:12.00, x:true, inc:["Â£13.50 from Apr26","Â£15.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"250GB Lite SIMO 24M", tier:"Lite", data:"250GB", price:11.00, inc:["Â£22.00 from Mar26","Â£23.50 from Apr26","Â£25.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"250GB Value SIMO 24M", tier:"Value", data:"250GB", price:13.50, inc:["Â£14.25 from Apr26","Â£28.50 from Jun26","Â£30.00 from Apr27"], features:["5G at no extra cost","Paramount+: 12m inclusive","Three+ Rewards","Go Roam â€“ Check plan details"]}),

    // Unlimited main
    P({name:"Unlimited Lite SIMO 24M", tier:"Lite", data:"Unlimited", price:13.50, inc:["Â£27.00 from Mar26","Â£28.50 from Apr26","Â£30.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Value SIMO 24M", tier:"Value", data:"Unlimited", price:32.00, inc:["Â£33.50 from Apr26","Â£35.00 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Complete SIMO 24M", tier:"Complete", data:"Unlimited", price:37.00, inc:["Â£38.50 from Apr26","Â£40.00 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),

    // Unlimited variants (X / S / Multi)
    P({name:"Unlimited Value SIMO 24M X", tier:"Value", data:"Unlimited", price:19.00, x:true, inc:["Â£20.50 from Apr26","Â£22.00 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Complete SIMO 24M S", tier:"Complete", data:"Unlimited", price:20.80, student:true, inc:["Â£22.30 from Apr26","Â£23.80 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Complete SIMO 24M X", tier:"Complete", data:"Unlimited", price:22.00, x:true, inc:["Â£23.50 from Apr26","Â£25.00 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Lite SIMO 24M S", tier:"Lite", data:"Unlimited", price:16.00, student:true, inc:["Â£17.50 from Apr26","Â£19.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Value SIMO 24M S", tier:"Value", data:"Unlimited", price:18.40, student:true, inc:["Â£19.90 from Apr26","Â£21.40 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"MultiSIM Unlimited Complete 24M", tier:"Complete", data:"Unlimited", price:19.00, multi:true, inc:["Â£20.50 from Apr26","Â£22.00 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"MultiSIM Unlimited Lite 24M", tier:"Lite", data:"Unlimited", price:13.00, multi:true, inc:["Â£14.50 from Apr26","Â£16.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards","50% Off for 24 Months"]}),
    P({name:"MultiSIM Unlimited Value 24M", tier:"Value", data:"Unlimited", price:16.00, multi:true, inc:["Â£17.50 from Apr26","Â£19.00 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam â€“ Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Lite SIMO 24M X", tier:"Lite", data:"Unlimited", price:16.00, x:true, inc:["Â£17.50 from Apr26","Â£19.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
  ];

  function P(obj){
    return {id:crypto.randomUUID(), ...obj};
  }

  // Load any saved price overrides
  const saved = JSON.parse(localStorage.getItem('priceOverrides')||'{}');
  for(const [id,price] of Object.entries(saved)){
    const p = plans.find(x=>x.id===id);
    if(p) p.price = price;
  }
  // Load any 6-month half-price flags by plan name
  // Migrate legacy local half6 flags into introMonths=6 (one-way)
const half6ByName = JSON.parse(localStorage.getItem('half6ByName')||'{}');
for(const p of plans){ if(half6ByName[p.name]) p.introMonths = 6; }
// Load new local intro months map (0/6/9/12)
const introByName = JSON.parse(localStorage.getItem('introByName')||'{}');
for(const p of plans){ if(introByName[p.name]) p.introMonths = Number(introByName[p.name])||0; }

  // â€”â€”â€” UI Render â€”â€”â€”
  const grid = document.getElementById('grid');
  const cartList = document.getElementById('cartList');
  const grand = document.getElementById('grand');
  let admin=false; let packageItems=[];

  function render(){
    // filters
    const q = document.getElementById('q').value.trim().toLowerCase();
    const tier = document.getElementById('tier').value;
    const data = document.getElementById('data').value;
    const wantX = document.getElementById('flagX').checked;
    const wantS = document.getElementById('flagS').checked;
    const wantM = document.getElementById('flagMulti').checked;
const introSel = document.getElementById('introSel')?.value || '';

    const filtered = plans.filter(p=>{
      if(q && !(p.name.toLowerCase().includes(q) || p.tier.toLowerCase().includes(q) || p.data.toLowerCase().includes(q))) return false;
      if(tier && p.tier!==tier) return false;
      if(data && p.data!==data) return false;
      if(wantX && !p.x) return false;
      if(wantS && !p.student) return false;
      if(wantM && !p.multi) return false;
      if(introSel){
  const im = p.introMonths || 0;
  if(String(im)!==String(introSel)) return false;
}
      return true;
    });

    grid.innerHTML = '';
    filtered.forEach(p=> grid.appendChild(card(p)) );
    renderPinned();

    // Cart
    cartList.innerHTML='';
    let totalLater=0; // months 7â€“24
    let totalFirst6=0; // months 1â€“6 with half-price applied where flagged
    packageItems.forEach(it=>{
      const row = document.createElement('div');
      row.className='item';
      row.innerHTML = `<div>
          <div class="name">${it.name}</div>
          ${it.note?`<div class="note">${it.note}</div>`:''}
        </div>
        <div>
          <input type="number" min="1" value="${it.qty}" style="width:60px" />
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <div>Â£${(it.price*it.qty).toFixed(2)}</div>
          <button class="btn danger" title="Remove">Ã—</button>
        </div>`;
      // qty change
      row.querySelector('input').addEventListener('change',e=>{
        it.qty = Math.max(1, Number(e.target.value||1));
        render();
      });
      // remove
      row.querySelector('button').addEventListener('click',()=>{
        packageItems = packageItems.filter(x=>x!==it);
        render();
      });
      cartList.appendChild(row);
      const plan = plans.find(p=>p.name===it.name);
      const base = it.price*it.qty;
      const isIntro = (plan && plan.introMonths>0);
const laterAdd = isIntro ? (base*2) : base;
totalLater += laterAdd;
const first6 = base; // intro period uses stored (half) price
totalFirst6 += first6;
    });
    const maxIntro = packageItems.reduce((m,it)=>{
  const plan = plans.find(p=>p.name===it.name);
  const n = plan ? (plan.introMonths||0) : 0;
  return Math.max(m,n);
}, 0);
    const rowFirst = document.getElementById('rowFirst6');
    const rowLater = document.getElementById('rowLater');
    const labelFirst = document.getElementById('labelFirst6');
    const labelLater = document.getElementById('labelLater');
    const gFirst = document.getElementById('grandFirst6');
    const gLater = document.getElementById('grandLater');

    if(maxIntro>0){
  if(rowFirst) rowFirst.style.display = '';
  if(labelFirst) labelFirst.textContent = `Months 1â€“${maxIntro} per month`;
  if(labelLater) labelLater.textContent = `Months ${maxIntro+1}â€“24 per month`;
  if(gFirst) gFirst.textContent = `Â£${totalFirst6.toFixed(2)}`;
  if(gLater) gLater.textContent = `Â£${totalLater.toFixed(2)}`;
}else{
  if(rowFirst) rowFirst.style.display = 'none';
  if(labelLater) labelLater.textContent = 'Total per month';
  if(gLater) gLater.textContent = `Â£${totalLater.toFixed(2)}`;
}{
      if(rowFirst) rowFirst.style.display = 'none';
      if(labelLater) labelLater.textContent = 'Total per month';
      if(gLater) gLater.textContent = `Â£${totalLater.toFixed(2)}`;
    }
    // Mobile footer
    const mb = document.getElementById('mobileBar');
    const mbFirst = document.getElementById('mFirst6')?.parentElement;
    const mbLater = document.getElementById('mLater')?.parentElement;
    if(mb && mbFirst && mbLater){
    if(maxIntro>0){
  mbFirst.style.display = '';
  mbLater.querySelector('span').textContent = `${maxIntro+1}â€“24m`;
  document.getElementById('mFirst6').textContent = `Â£${totalFirst6.toFixed(2)}`;
  document.getElementById('mLater').textContent = `Â£${totalLater.toFixed(2)}`;
}else{
  mbFirst.style.display = 'none';
  mbLater.querySelector('span').textContent = 'Total';
  document.getElementById('mLater').textContent = `Â£${totalLater.toFixed(2)}`;
}
    }
  }

  function card(p){
    const el = document.createElement('div');
    el.className='card';
    const flags = [];
    if(p.multi) flags.push('<span class="tag teal">Multiâ€‘SIM</span>');
    if(p.x) flags.push('<span class="tag teal">X</span>');
    if(p.student) flags.push('<span class="tag teal">Student</span>');
    if(p.introMonths>0) flags.push(`<span class="tag half">Intro ${p.introMonths}m 1/2</span>`);

    const priceField = admin ? `<input class="editable" type="number" step="0.01" value="${p.price}" style="width:110px;padding:8px;border-radius:8px;color:var(--ink)" />`
                             : `<span class="price">Â£${p.price.toFixed(2)}</span>`;

    el.innerHTML = `
      <div class="tags">${flags.join('')}</div>
      <h3>${p.name}</h3>
      <div class="muted">Data: <b>${p.data}</b> â€¢ Tier: <b>${p.tier}</b></div>
      <div>From ${priceField} /month</div>
      <div style="display:flex;gap:8px;margin-top:auto">
        <button class="btn">Add</button>
        <button class="btn sec" title="Add & duplicate">Add Ã—2</button>
      </div>
      <div class="muted" data-admin="intro" style="display:none">
  <label style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
    Intro half price:
    <select data-intro-sel>
      <option value="0" ${!p.introMonths?'selected':''}>None</option>
      <option value="6" ${p.introMonths===6?'selected':''}>6m</option>
      <option value="9" ${p.introMonths===9?'selected':''}>9m</option>
      <option value="12" ${p.introMonths===12?'selected':''}>12m</option>
    </select>
  </label>
</div>
    `;

    // Admin live price edit
    if(admin){
      const input = el.querySelector('input[type="number"]');
      input.addEventListener('change',e=>{
        const val = Number(e.target.value||0);
        if(!isNaN(val) && val>0){
          p.price = val;
          const overrides = JSON.parse(localStorage.getItem('priceOverrides')||'{}');
          overrides[p.id]=val; localStorage.setItem('priceOverrides',JSON.stringify(overrides));
          render();
        }
      });
    }

    // Admin: set intro half-price months (0/6/9/12)
const adminRow = el.querySelector('[data-admin="intro"]');
if (admin && adminRow) {
  adminRow.style.display = 'block';
  const sel = adminRow.querySelector('[data-intro-sel]');
  sel.addEventListener('change',(e)=>{
    p.introMonths = Number(e.target.value||0);
    const map = JSON.parse(localStorage.getItem('introByName')||'{}');
    if (p.introMonths>0) map[p.name]=p.introMonths; else delete map[p.name];
    localStorage.setItem('introByName', JSON.stringify(map));
    render();
  });
}

    const add = (qty)=>{
      const ok = canAdd(p);
      if(!ok.allowed){
        alert(ok.reason);
        return;
      }
      const existing = packageItems.find(x=>x.id===p.id);
      if(existing) existing.qty += qty; else packageItems.push({id:p.id,name:p.name,price:p.price,qty, note:noteFor(p)});
      render();
    }
    // Card click for plan details (not buttons)
    el.addEventListener('click', function(e){
      if(e.target.closest('button')) return;
      showDetails(p);
    });
    el.querySelector('.btn').addEventListener('click',e=>{e.stopPropagation();add(1)});
    el.querySelector('.btn.sec').addEventListener('click',e=>{e.stopPropagation();add(2)});
    return el;
  }

  function showDetails(p){
    const details = document.getElementById('details');
    const panel = details.closest('.details');
    if(panel && panel.style.display==='none'){ panel.style.display='block'; }
    details.innerHTML = `
      <div style="font-size:16px;font-weight:600;margin-bottom:2px">${p.name}</div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:8px">Tier: <b>${p.tier}</b> â€¢ Data: <b>${p.data}</b></div>
      <div style="margin-bottom:8px"><b>Price:</b> Â£${p.price.toFixed(2)} /month</div>
      <div style="margin-bottom:8px"><b>Price increases:</b> ${p.inc ? p.inc.join(' â†’ ') : 'None'}</div>
      <div><b>Features:</b></div>
      <ul>
        ${p.features.map(f=>`<li>${f}</li>`).join('')}
      </ul>
    `;
    details.closest('.details').scrollIntoView({behavior:'smooth',block:'start'});
  }

  function dataRank(val){ // to compare data amounts
    if(val==='Unlimited') return 10_000; // arbitrarily huge
    return Number(val.replace('GB',''));
  }

  function hasBase(){
    return packageItems.some(x=>!/Multi| 24M X|X$/.test(x.name) && !/Multi/.test(x.name) && !/ X/.test(x.name));
  }

  function highestData(){
    let max=0;
    for(const it of packageItems){
      const match = it.name.match(/(\d+GB|Unlimited)/);
      if(match) max = Math.max(max, dataRank(match[1]));
    }
    return max;
  }

  function canAdd(p){
    if(p.multi){
      const baseMax = highestData();
      if(!hasBase()) return {allowed:false, reason:'Add a base SIM plan first before Multiâ€‘SIM.'};
      if(dataRank(p.data) > baseMax) return {allowed:false, reason:'Multiâ€‘SIM must be same or lower data than your highest base plan.'};
    }
    if(p.x){
      if(!hasBase()) return {allowed:false, reason:'Crossâ€‘sell (X) must be added on top of a base SIM plan.'};
    }
    return {allowed:true};
  }

  function noteFor(p){
    if(p.multi) return 'Multiâ€‘SIM addâ€‘on';
    if(p.x) return 'Crossâ€‘sell addâ€‘on';
    if(p.student) return 'Student tariff';
    if(p.introMonths>0) return `${p.introMonths} months half price`;
    return '';
  }

  // controls
['q','tier','data','flagX','flagS','flagMulti','introSel'].forEach(id=> document.getElementById(id)?.addEventListener('input',render));  document.getElementById('clearBtn').addEventListener('click',()=>{packageItems=[];render()});
  document.getElementById('exportBtn').addEventListener('click',()=>{
    // recompute totals for export (supports introMonths 6/9/12 and legacy half6)
    let totalLater=0, totalFirst=0;
    const maxIntro = packageItems.reduce((m,it)=>{
      const plan = plans.find(p=>p.name===it.name);
      const n = plan ? (plan.introMonths || (plan.half6?6:0) || 0) : 0;
      return Math.max(m,n);
    }, 0);
    for(const it of packageItems){
      const plan = plans.find(p=>p.name===it.name);
      const base = it.price*it.qty;
      const isIntro = !!(plan && (plan.introMonths>0 || plan.half6));
      totalLater += isIntro ? (base*2) : base; // post-intro months use double
      totalFirst += base;                      // intro months use stored (half) price
    }
    const lines = packageItems.map(it=>`${it.qty} Ã— ${it.name} â€” Â£${(it.price*it.qty).toFixed(2)}`);
    if(maxIntro>0){
      lines.push(`Months 1â€“${maxIntro} per month: Â£${totalFirst.toFixed(2)}`);
      lines.push(`Months ${maxIntro+1}â€“24 per month: Â£${totalLater.toFixed(2)}`);
    }else{
      lines.push(`Total per month: Â£${totalLater.toFixed(2)}`);
    }
    const blob = new Blob([lines.join('\n')],{type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='package.txt'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('loginBtn').addEventListener('click',()=>{
    if(admin){
      admin=false;
      document.getElementById('adminState').style.display='none';
      const ebtn=document.getElementById('editPinnedBtn'); if(ebtn) ebtn.style.display='none';
      const np=document.getElementById('newPinnedFromCart'); if(np) np.style.display='none';
      const ex=document.getElementById('exportPinnedJson'); if(ex) ex.style.display='none';
      const eo=document.getElementById('exportOverridesBtn'); if(eo) eo.style.display='none';
      const ro=document.getElementById('reloadOverridesBtn'); if(ro) ro.style.display='none';
      closePinnedEditor();
      render();
      return;
    }
    const pw = prompt('Enter admin password');
    if(pw===ADMIN_PASS){
      admin=true;
      document.getElementById('adminState').style.display='inline';
      const ebtn=document.getElementById('editPinnedBtn'); if(ebtn) ebtn.style.display='inline-block';
      const np=document.getElementById('newPinnedFromCart'); if(np) np.style.display='inline-block';
      const ex=document.getElementById('exportPinnedJson'); if(ex) ex.style.display='inline-block';
      const eo=document.getElementById('exportOverridesBtn'); if(eo) eo.style.display='inline-block';
      const ro=document.getElementById('reloadOverridesBtn'); if(ro) ro.style.display='inline-block';
      render();
    }
    else if(pw!==null){ alert('Incorrect password'); }
  });

  function bindFiltersToggle(){
    const btn = document.getElementById('toggleFilters');
    const body = document.getElementById('filtersBody');
    if(!btn || !body) return;
    const set = (open)=>{ body.style.display = open? 'block' : 'none'; btn.textContent = open? 'â–²' : 'â–¼'; };
    // Default: open on desktop, collapsed on mobile
    const isMobile = window.matchMedia('(max-width: 760px)').matches;
    set(!isMobile ? true : false);
    btn.addEventListener('click', ()=>{ set(body.style.display==='none'); });
  }

  console.info("SIM Package Builder running", DESIGN_VERSION);
  bindPinnedEditor();
  bindPinFromCart();
  bindExportPinned();
  bindFiltersToggle();
  function bindExportOverrides(){
    const btn = document.getElementById('exportOverridesBtn');
    if(!btn) return;
    btn.onclick = ()=>{
      const prices = {}; const intro = {};
      plans.forEach(p=>{ prices[p.name] = Number(p.price); if(p.introMonths>0) intro[p.name]=p.introMonths; });
      const payload = { pricesByName: prices, introMonthsByName: intro, half6Names: Object.keys(intro).filter(n=>intro[n]===6) };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='overrides.json'; a.click(); URL.revokeObjectURL(url);
    };
  }
  bindExportOverrides();
  function bindReloadOverrides(){
    const btn = document.getElementById('reloadOverridesBtn');
    if(!btn) return;
    btn.onclick = ()=> loadOverridesFromJSON();
  }
  bindReloadOverrides();
  bindPinnedToggle();
  render();
  document.getElementById('mScrollCart')?.addEventListener('click', ()=>{
    document.querySelector('.cart')?.scrollIntoView({behavior:'smooth', block:'start'});
  });
  async function updateTimestampFromGitHub(){
    try{
      const resp = await fetch('https://api.github.com/repos/JXHNWACK/1842/commits/main');
      if(!resp.ok) return;
      const data = await resp.json();
      const iso = data.commit.committer.date;
      const dt = new Date(iso);
      const formatted = dt.toLocaleString('en-GB',{ dateStyle:'short', timeStyle:'short' });
      const el = document.getElementById('lastUpdated');
      if(el) el.textContent = "â€¢ last updated " + formatted;
    }catch(e){ console.warn("Could not fetch commit info", e); }
  }
  updateTimestampFromGitHub();
  </script>
</body>
</html>
mp