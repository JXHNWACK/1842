<!DOCTYPE html>
<!-- DESIGN FREEZE: Layout and styling locked as of 2025-09-08 (v1.0). Do not alter structure/visuals unless Wade explicitly requests. -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="x-design-version" content="v1.0-2025-09-08" />
  <title>Leicester Gallowtree Gate ‚Äì Package Builder / One Pager.</title>
  <style>
    :root{ --bg:#ECE4D8; --panel:#F6EEE3; --muted:#5b534a; --ink:#1a1917; --primary:#2f2a25; --primaryText:#fffaf5; --border:#E0D6C8; --accent:#ff7a59; --red:#d92d20; --amber:#b7791f; }
    /* Dark/Warm theme */
    body[data-theme="dark"]{ --bg:#1f1a16; --panel:#26201b; --muted:#c8bfb5; --ink:#fbf7f2; --primary:#f0e6db; --primaryText:#1f1a16; --border:#3a332c; --accent:#ff9a76; --red:#ff6b5a; --amber:#e0a44a; }
    body[data-theme="dark"] .chip-accent{ color:#1f1a16 }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); font-size:16px; }
    html, body{ max-width:100%; overflow-x:hidden }
    header{position:static;top:auto;z-index:5;background:var(--panel);border-bottom:1px solid var(--border)}
    .bar{max-width:1842px;margin:auto;padding:14px 18px;display:flex;gap:12px;align-items:center}
    .ver{margin-left:8px;color:var(--muted);font-size:12px}
    h1{color:var(--ink);font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}

    .wrap{max-width:1842px;margin:16px auto;padding:0 18px;display:grid;grid-template-columns:1fr 340px;gap:16px}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}

    .filters,.catalog,.cart{background:var(--panel);border:1px solid var(--border);border-radius:12px}
    .filters{padding:14px; grid-column:1;}
    .filters h2{font-size:14px;color:var(--ink);margin:0 0 8px}
    .filters label{color:var(--muted);font-size:12px}
    /* Compact Filters grid */
    .filters-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; align-items:stretch }
    .filters-grid .fitem{ display:block }
    .filters-grid select,
    .filters-grid input[type="search"]{ width:100%; min-width:0 }
    .filters-grid .chip{ justify-content:center; width:100% }
    @media (max-width: 900px){ .filters-grid{ grid-template-columns:repeat(2,1fr) } }
    .row{display:flex;gap:8px;flex-wrap:wrap}
    select,input[type="search"]{background:var(--panel);border:1px solid var(--border);color:var(--ink);padding:10px 12px;border-radius:10px;min-width:160px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#f3eee6;color:var(--ink);padding:8px 10px;border-radius:999px;cursor:pointer;font-size:12px}
    .chip-accent{background:var(--accent);color:#fff;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600}
    #overridesBadge {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 6px;
}
    #pinnedBadge { font-size: 11px; padding: 2px 6px; border-radius: 6px }
    
    /* Pinned packages */
    .pinned{
      background: linear-gradient(180deg, #fff4ec 0%, #fdf8f5 60%);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      margin-top:12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 0 0 4px rgba(255,122,89,0.08);
      border-left:8px solid var(--accent);
      grid-column:1
    }
    .pinned h2{
      font-size:14px;
      color:var(--ink);
      margin:0 0 8px;
      display:flex;
      align-items:center;
      gap:8px;
      border-bottom:2px solid var(--accent);
      padding-bottom:4px;
    }
    .pinned h2 .chip-accent {
      box-shadow: 0 0 6px rgba(255,122,89,0.6);
    }
    .pinned .actions{margin-left:auto;display:flex;gap:8px}
    .pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:1060px){.pgrid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.pgrid{grid-template-columns:1fr}}
    .pcard{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:6px}
    .pcard:hover{box-shadow:0 2px 12px rgba(0,0,0,0.08);transform:translateY(-2px)}
    @keyframes pinIn{ from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:none } }
    .pcard.appear{ animation: pinIn .35s ease both }
    .pcard .ptitle{font-weight:700;color:var(--ink);font-size:13px}
    .plist{color:var(--muted);font-size:12px;line-height:1.35}
    .prow{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
    .ptotal{font-weight:800;color:var(--primary)}
    .pcard .del{display:none;margin-left:6px;border:none;background:transparent;cursor:pointer;color:var(--muted);font-size:14px}
    .pcard .top{display:flex;align-items:center;justify-content:space-between}
    .btn.sm{padding:6px 8px;font-size:12px;border-radius:8px}
    .pedit{display:none;margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
    .pedit .hint{color:var(--muted);font-size:12px;margin-bottom:6px}
    .pedit textarea{width:100%;min-height:140px;border:1px solid var(--border);border-radius:8px;background:var(--panel);color:var(--ink);padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
    .pedit .row{display:flex;gap:8px;margin-top:8px}

    .catalog{padding:12px; grid-column:1;}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:1060px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}

    /* Two-up cards on mobile / small tablets */
    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
      .grid{ gap:8px }
    }
    /* Keep two-up even on very small phones */
    @media (max-width: 420px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }

    .card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; cursor:pointer; transition:box-shadow .12s, transform .05s; }
    .card:hover{ box-shadow:0 2px 10px rgba(0,0,0,.05);}
    .details{
      background:var(--panel);
      border-radius:14px;
      padding:20px 18px;
      margin-top:18px;
      color:var(--ink);
      border:1px solid #ddd;
      box-shadow:0 2px 8px 0 rgba(0,0,0,0.03);
      display:none;
      grid-column:1;
    }
    .details h2{
      margin-top:0;
      font-size:18px;
      color:var(--ink);
    }
    .details ul{
      margin:8px 0 0 18px;
      padding:0;
      color:var(--muted);
      font-size:14px;
    }
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#faf3eb;color:#2b2622}
    .tag.multi{border-color:#38bdf8;background:#ecfeff;color:#075985;box-shadow:0 0 0 2px rgba(56,189,248,.25),0 0 8px rgba(56,189,248,.35)}
    .tag.x{border-color:#fb923c;background:#fff7ed;color:#7c2d12;box-shadow:0 0 0 2px rgba(251,146,60,.25),0 0 8px rgba(251,146,60,.35)}
    .tag.student{border-color:#a78bfa;background:#f5f3ff;color:#3730a3;box-shadow:0 0 0 2px rgba(167,139,250,.25),0 0 8px rgba(167,139,250,.35)}
    .tag.half{border-color:#34d399;background:#ecfdf5;color:#065f46;box-shadow:0 0 0 2px rgba(52,211,153,.25),0 0 8px rgba(52,211,153,.35)}
    .card h3{color:var(--ink);margin:0;font-size:15px;line-height:1.2}
    .price{color:var(--primary);font-weight:800;font-size:20px}
    .save{ color:var(--accent); font-weight:800; font-size:12px }
    .muted{color:var(--muted);font-size:13px}
    .features{display:flex;flex-direction:column;gap:4px;color:var(--muted);font-size:12px;margin-top:6px}
    .btn{background:var(--primary);border:1px solid var(--primary);color:var(--primaryText);font-weight:700;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn:focus{outline:2px solid var(--accent);outline-offset:2px}
    .btn.sec{background:#fff;border:1px solid var(--border);color:var(--ink)}
    .btn.danger{background:var(--red);border:1px solid var(--red);color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.toggle{ background:#fff; border:1px solid var(--border); color:var(--ink) }
    .btn.toggle.on{ background:#10b981; border-color:#10b981; color:#fff }

    .cart{padding:14px;position:sticky;top:74px;align-self:start; grid-column:2;}
    .cart h2{margin:0 0 10px;color:var(--ink);font-size:16px}
    .cart .item{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;border-top:1px dashed #2a365b;padding-top:10px;margin-top:10px}
    .qty{ display:inline-flex; gap:6px; align-items:center }
    .qty .btn.sm{ padding:6px 8px }
    .cart input[type="number"]{ width:60px; height:36px }
    .cart .item .name{color:var(--ink);font-size:13px}
    .cart .item .note{color:var(--amber);font-size:11px}
    .total{display:flex;justify-content:space-between;border-top:2px solid var(--border);margin-top:12px;padding-top:12px;color:var(--ink);font-weight:800}
    .rule{font-size:12px;color:var(--muted);margin-top:10px}

    .admin-bar{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .admin-on{color:var(--amber);font-size:12px}
    .editable{border:1px dashed var(--amber);background:#fff;color:var(--ink)}

    .mbar{ display:none }
    /* Mobile optimisations */
    @media (max-width: 760px){
      .wrap{grid-template-columns:1fr; padding:0 12px}
      .filters{grid-column:1}
      .pinned{grid-column:1}
      .details{grid-column:1}
      .catalog{grid-column:1}
      .cart{grid-column:1; position:static; top:auto;}

      .grid{grid-template-columns:repeat(2,1fr); gap:8px}
      .pgrid{grid-template-columns:1fr}

      /* Make filter controls stack nicely */
      .row{gap:6px}
      /* .row > *{flex:1 1 100%; min-width:0} */ /* removed: replaced by filters-grid */
      select, input[type="search"]{width:100% !important; min-width:0}

      /* Touch-friendly controls */
      .btn{padding:12px}
      .btn.sm, .btn.sec.sm{padding:8px 10px}
      .card{padding:12px}
      header .row{gap:8px}

      /* Header wraps to avoid forcing page width */
      header .bar{ flex-wrap:wrap }
      header .bar .row{ width:100%; flex-wrap:wrap; gap:6px }
      /* Smaller header on mobile */
      header .bar{ padding:6px 10px }
      header h1{ font-size:14px }
      header .ver{ display:none }
      header .row .btn{ padding:8px 10px; font-size:12px }

      /* Tiny sticky footer bar on mobile */
      .mbar{ display:flex; position:fixed; bottom:0; left:0; right:0; background:var(--panel); border-top:1px solid var(--border); padding:8px 10px; align-items:center; gap:10px; z-index:10 }
      .mbar .tot{ display:flex; flex-direction:column; font-size:12px; line-height:1.2 }
      .mbar .tot b{ font-size:13px }
      .mbar .spacer{ flex:1 }
      .mbar .btn{ min-height:36px }
      body{ padding-bottom:64px } /* avoid content underlap */
      .filters{ padding:8px }
      .filters h2{ font-size:13px; margin-bottom:4px }
      .filters .row{ gap:6px; margin-bottom:6px !important }
      .filters select, .filters input[type="search"]{ padding:8px 10px; min-width:0 }
      .chip{ padding:6px 8px; font-size:11px }
      .filters .muted{ font-size:11px; display:none } /* hide helper tip on mobile to save space */

      /* Extra‚Äëcompact cards */
      .card{ padding:8px }
      .card h3{ font-size:13px; white-space:normal; overflow:hidden }
      .muted{ font-size:11px }
      .price{ font-size:18px }
      .tag{ font-size:10px; padding:2px 6px }
      .card div[style*="margin-top:auto"] .btn{ min-height:36px; font-size:12px }

      /* Extra‚Äëcompact filters */
      .filters{ padding:6px }
      .filters h2{ font-size:12px; margin-bottom:2px }
      .filters .row{ gap:4px; margin-bottom:4px !important }
      .filters select, .filters input[type="search"]{ padding:6px 8px; min-width:0 }
      .chip{ padding:4px 6px; font-size:10px }

      /* ===== Ultra-compact mobile mode ===== */
      body{ font-size:14px }

      /* Header shrink */
      header .bar{ padding:4px 8px }
      header h1{ font-size:12px }
      header .row .btn{ padding:6px 8px; font-size:11px }

      /* Filters tighter */
      .filters{ padding:4px }
      .filters h2{ font-size:11px; margin-bottom:2px }
      .filters .row{ gap:4px; margin-bottom:4px !important }
      .filters select, .filters input[type="search"]{ padding:6px 8px; min-width:0 }
      .chip{ padding:3px 6px; font-size:10px }

      /* Cards: two-up tiny, readable */
      .grid{ gap:6px }
      .card{ padding:6px }
      .card h3{ font-size:12px; line-height:1.2; white-space:normal; overflow:hidden }
      .muted{ font-size:10.5px }
      .price{ font-size:16px }
      .tag{ font-size:9px; padding:1px 5px }
      .card div[style*="margin-top:auto"] .btn{ min-height:32px; font-size:11px; padding:6px 8px }
      /* Hide the small meta line to save height */
      .card > .muted{ display:none }

      /* Cart compaction */
      .cart{ padding:10px }
      .cart h2{ font-size:14px }
      .cart .item{ gap:6px }
      .cart .item .name{ font-size:12px }
      .cart .item .note{ font-size:10px }
      .cart input[type="number"]{ width:50px; height:36px }
      .qty .btn{ padding:6px 8px }
      .total{ font-size:14px }
      .rule{ font-size:11px }

      /* Sticky footer: smaller */
      .mbar{ padding:6px 8px }
      .mbar .tot{ font-size:11px }
      .mbar .tot b{ font-size:12px }
      .mbar .btn{ min-height:32px }
    }
    /* Show sticky footer on small screens incl. big iPhones */
    @media (max-width: 900px){
      .mbar{ display:flex }
      body{ padding-bottom: calc(64px + env(safe-area-inset-bottom, 0px)) }
      .mbar{ padding-bottom: env(safe-area-inset-bottom, 0px); z-index: 999 }
    }
    /* Welcome overlay */
    .welcome-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.35); backdrop-filter:saturate(120%) blur(4px); z-index:2000; display:none }
    .welcome{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2001 }
    .welcome .panel{ max-width:520px; width:92vw; background:linear-gradient(180deg,#fff7f1 0%, #f6eee3 100%); border:1px solid var(--border); border-radius:16px; box-shadow:0 14px 44px rgba(0,0,0,.18), 0 0 0 4px rgba(255,122,89,.08); padding:18px }
    .welcome h2{ margin:0 0 8px; font-size:18px; color:var(--ink); display:flex; align-items:center; gap:10px; }
    .welcome h2::after{ content:""; flex:1; height:2px; background:var(--accent); border-radius:2px }
    .welcome p{ margin:6px 0; color:var(--muted); font-size:13px }
    .welcome .tips{ background:var(--panel); border:1px dashed var(--border); border-radius:12px; padding:10px; margin:10px 0; font-size:12px; color:var(--ink) }
    .welcome .row{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px }
    .welcome .muted{ font-size:12px }
    body.modal-open{ overflow:hidden }
    @media (max-width:760px){ .welcome .panel{ padding:14px } .welcome h2{ font-size:16px } }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>Leicester Gallowtree Gate ‚Ä¢ Package Builder / One Pager.</h1>
      <span id="lastUpdated" class="ver" style="display:inline-block">‚Ä¢ last updated ‚Ä¶</span>
      <span id="overridesBadge" class="chip-accent" style="display:none">Overrides active</span>
      <span id="pinnedBadge" class="chip-accent" style="display:none">Pinned active</span>
      <div class="row" style="margin-left:auto">
        <button id="loginBtn" class="btn sec">Muhammad/Wade/Karin</button>
        <button id="exportBtn" class="btn">Export package</button>
        <button id="exportOverridesBtn" class="btn sec" style="display:none" title="Download overrides.json for GitHub">Export overrides</button>
        <button id="reloadOverridesBtn" class="btn sec" style="display:none" title="Reload overrides.json">Reload overrides</button>
      </div>
    </div>
  </header>

  <div id="changelogBar" style="display:none;background:#fff7ed;border-bottom:1px solid var(--border);">
    <div style="max-width:1842px;margin:auto;padding:8px 18px;display:flex;gap:10px;align-items:flex-start">
      <strong style="color:var(--amber);font-size:12px;white-space:nowrap">Recent changes</strong>
      <div id="changelogList" style="font-size:12px;color:var(--ink);"></div>
      <button id="changelogClose" class="btn sec sm" style="margin-left:auto">Hide</button>
    </div>
    <div class="welcome-backdrop" id="welcomeBackdrop"></div>
    <div class="welcome" id="welcome">
      <div class="panel" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
        <h2 id="welcomeTitle">Welcome to Leicester Gallowtree Gate</h2>
        <p style="font-weight:600;color:var(--ink)">Package Builder / One Pager</p>
        <div class="tips">
          <div>‚Ä¢ Tap a card to add. Use <b>Override</b> for existing customers.</div>
          <div>‚Ä¢ Sticky footer shows live totals. ‚ÄúScroll to cart‚Äù jumps to the basket.</div>
          <div>‚Ä¢ Pinned packages are what we‚Äôre pushing today.</div>
        </div>
        <label class="chip" style="user-select:none"><input id="welcomeDontShow" type="checkbox" /> Don‚Äôt show again on this device</label>
        <div class="row">
          <button id="welcomeStart" class="btn">Start</button>
        </div>
      </div>
    </div>

  <div class="wrap">
    <section class="filters">
      <h2>Filters <button id="toggleFilters" class="btn sec sm" style="margin-left:8px">‚ñ≤</button></h2>
      <div id="filtersBody">
        <div class="filters-grid" style="margin-bottom:8px">
          <div class="fitem"><input id="q" type="search" placeholder="Search e.g. 120GB, Lite, Unlimited‚Ä¶" /></div>
          <div class="fitem">
            <select id="tier">
              <option value="">All tiers</option>
              <option>Lite</option>
              <option>Value</option>
              <option>Complete</option>
            </select>
          </div>
          <div class="fitem">
            <select id="data">
              <option value="">All data</option>
              <option>25GB</option>
              <option>120GB</option>
              <option>160GB</option>
              <option>250GB</option>
              <option>Unlimited</option>
            </select>
          </div>
          <div class="fitem">
            <select id="introSel" title="Intro half-price">
              <option value="">Intro price: Any</option>
              <option value="6">6 months</option>
              <option value="9">9 months</option>
              <option value="12">12 months</option>
            </select>
          </div>
          <label class="chip fitem"><input id="flagX" type="checkbox" /> Cross‚Äësell (X)</label>
          <label class="chip fitem"><input id="flagS" type="checkbox" /> Student (S)</label>
          <label class="chip fitem"><input id="flagMulti" type="checkbox" /> Multi‚ÄëSIM</label>
          <div class="fitem"><button id="resetFilters" class="btn sec sm" title="Clear all filters">Reset</button></div>
        </div>
        <div class="muted">Tip: Click a plan to add it to the package. Multi‚ÄëSIM requires a base plan in the package with <b>same or higher data</b>. Cross‚Äësell (X) requires a base plan too.</div>
        <div class="admin-bar"><span id="adminState" class="admin-on" style="display:none">Admin mode: prices editable</span></div>
      </div>
    </section>


    <section class="pinned" id="pinnedSection">
      <h2>üìå PINNED PACKAGES
        <span class="chip-accent">Recommended</span>
        <button id="togglePinned" class="btn sec sm" style="margin-left:8px">‚ñº</button>
        <span class="actions">
          <button id="editPinnedBtn" class="btn sec sm" style="display:none">Edit</button>
          <button id="newPinnedFromCart" class="btn sm" style="display:none">Pin cart</button>
          <button id="exportPinnedJson" class="btn sec sm" style="display:none" title="Download pinned.json for GitHub">Export JSON</button>
        </span>
      </h2>
      <div id="pinned" class="pgrid"></div>
      <div id="pinnedEditor" class="pedit">
        <div class="hint">Admin-only. Edit JSON, then Save. Structure: <code>[{ title, items:[{ name, qty }] }]</code></div>
        <textarea id="pinnedTextarea"></textarea>
        <div class="row">
          <button id="pinnedSave" class="btn sm">Save</button>
          <button id="pinnedCancel" class="btn sec sm">Cancel</button>
          <button id="pinnedReset" class="btn sec sm" title="Reset to defaults">Reset</button>
        </div>
      </div>
    </section>

    <section class="details"><h2>Plan Details</h2><div id="details"></div></section>

    <section class="catalog">
      <div id="grid" class="grid"></div>
    </section>

    <aside class="cart">
      <h2>Selected Package</h2>
      <div id="cartSummary" class="muted" style="margin-bottom:6px;font-size:12px"></div>
      <div id="cartSavings" class="chip-accent" style="display:none;margin-bottom:8px;font-size:12px"></div>
      <div class="row" style="margin-bottom:8px; gap:8px">
        <button id="clearBtnCart" class="btn sec sm">Clear package</button>
      </div>
      <div id="cartList"></div>
      <div class="total" id="rowFirst6"><span id="labelFirst6">Months 1‚Äì6 per month</span><span id="grandFirst6">¬£0.00</span></div>
      <div class="total" id="rowLater"><span id="labelLater">Months 7‚Äì24 per month</span><span id="grandLater">¬£0.00</span></div>
      <div class="total" id="rowAvg"><span>Effective average (24m)</span><span id="avg24">¬£0.00</span></div>
      <div class="row" id="overrideRow" style="margin-top:8px; gap:8px; align-items:center">
        <button id="overrideBtn" class="btn toggle sm" title="Allow Multi‚ÄëSIM and X without base">Override rules (existing customer): OFF</button>
        <span class="muted" style="font-size:11px">Allows Multi‚ÄëSIM and X without base plan.</span>
      </div>
      <div class="rule" id="rulesNote">Rules enforced: (1) Multi‚ÄëSIM must be ‚â§ highest data in package. (2) Cross‚Äësell/X requires at least one non‚ÄëMulti, non‚ÄëX base plan.</div>
    </aside>
    <div class="mbar" id="mobileBar">
      <div class="tot"><span>1‚Äì6m</span><b id="mFirst6">¬£0.00</b></div>
      <div class="tot"><span>7‚Äì24m</span><b id="mLater">¬£0.00</b></div>
      <div class="spacer"></div>
      <button class="btn toggle sm" id="mOverride" title="Allow Multi‚ÄëSIM and X without base">Override: OFF</button>
      <button class="btn sec" id="mClear">Clear</button>
      <button class="btn" id="mScrollCart">Scroll to cart</button>
    </div>
  </div>

  <script>
  // ‚Äî‚Äî‚Äî Data ‚Äî‚Äî‚Äî
  // NOTE: You can edit prices live in Admin mode, and they persist in localStorage.
  const ADMIN_PASS = "1842"; // change this to your preferred password
  const DESIGN_VERSION = "v1.0-2025-09-08"; // Design freeze identifier

  // Curated packages to promote (edit titles or items as needed)
  let PINNED = [
    {
      title: 'Push: Unlimited Lite',
      items: [ { name: 'Unlimited Lite SIMO 24M', qty: 1 } ]
    },
    {
      title: 'Push: 160GB Value + Multi 160GB',
      items: [
        { name: '160GB Value SIMO 24M', qty: 1 },
        { name: '160GB Lite SIMO Multi SIM 24M', qty: 1 }
      ]
    },
    {
      title: 'Push: 250GB Value',
      items: [ { name: '250GB Value SIMO 24M', qty: 1 } ]
    }
  ];
  // Load saved pinned packages if present
  try{
    const savedPinned = JSON.parse(localStorage.getItem('pinnedPackages')||'null');
    if(Array.isArray(savedPinned)) PINNED = savedPinned;
  }catch{ /* ignore parse errors */ }

  // Try to load shared pinned packages from pinned.json at site root (if repo includes it)
  async function loadPinnedFromJSON(){
    try{
      const resp = await fetch('./pinned.json', {cache:'no-store'});
      if(!resp.ok) return; // no shared file present
      const data = await resp.json();
      if(Array.isArray(data)){
        PINNED = data;
        const pb = document.getElementById('pinnedBadge'); if(pb) pb.style.display='inline-block';
        renderPinned();
      }
    }catch(e){ /* ignore if not present */ }
  }
  loadPinnedFromJSON();

  // Load shared price/flag overrides if overrides.json exists at root
  async function loadOverridesFromJSON(){
    try{
      const resp = await fetch(`./overrides.json?v=${Date.now()}`, {cache:'no-store'});
      if(!resp.ok) return; // no shared overrides file present
      const data = await resp.json();
      const stats = applyOverrides(data);
      // Show badge with stats
      const badge=document.getElementById('overridesBadge');
      if(badge){
        badge.style.display='inline-block';
        badge.textContent = `Overrides active (${stats.priceUpdates} prices, ${stats.introUpdates} intro)`;
      }
      render();
    }catch(e){ console.warn('overrides.json not loaded', e); }
  }
function applyOverrides(data){
  let priceUpdates = 0, introUpdates = 0;
  const missingNames = [];
  if(data && data.pricesByName){
    for(const [name,price] of Object.entries(data.pricesByName)){
      const p = plans.find(x=>x.name===name);
      if(p && typeof price==='number') { p.price = price; priceUpdates++; }
      else { missingNames.push(name); }
    }
  }
  // New: explicit intro months map (6/9/12)
  if(data && data.introMonthsByName){
    for(const [name,months] of Object.entries(data.introMonthsByName)){
      const p = plans.find(x=>x.name===name);
      const m = Number(months);
      if(p && (m===6 || m===9 || m===12)) { p.introMonths = m; introUpdates++; }
    }
  }
  // Legacy fallback: half6Names => introMonths=6
  if(data && Array.isArray(data.half6Names)){
    for(const name of data.half6Names){
      const p = plans.find(x=>x.name===name);
      if(p){ if(!p.introMonths) introUpdates++; p.introMonths = 6; }
    }
  }
  if(missingNames.length){
    console.warn('Overrides: no plan matches for', missingNames);
  }
  return { priceUpdates, introUpdates };
}
  loadOverridesFromJSON();

  function savePinned(){ localStorage.setItem('pinnedPackages', JSON.stringify(PINNED)); }

function packageTotal(pkg){
    let total = 0;
    for(const it of pkg.items){
      const p = plans.find(x=>x.name===it.name);
      if(p){
        const qty = it.qty||1;
        const base = p.price * qty; // stored price = half price when p.half6
        total += (p.introMonths>0) ? (base*2) : base; // later months use double if half6
      }
    }
    return total;
}

function packageFirst6(pkg){
    let total = 0;
    for(const it of pkg.items){
      const p = plans.find(x=>x.name===it.name);
      if(p){
        const qty = it.qty||1;
        const base = p.price * qty; // first 6 months use the stored (half) price if half6
        total += base;
      }
    }
    return total;
}

  function addPinnedToCart(pkg){
    for(const it of pkg.items){
      const p = plans.find(x=>x.name===it.name);
      if(!p){ alert(`Plan not found: ${it.name}`); continue; }
      const check = canAdd(p);
      if(!check.allowed){ alert(check.reason); return; }
      const existing = packageItems.find(x=>x.id===p.id);
      const qty = it.qty||1;
      if(existing) existing.qty += qty; else packageItems.push({id:p.id,name:p.name,price:p.price,qty, note:noteFor(p)});
    }
    render();
  }

  function renderPinned(){
    const wrap = document.getElementById('pinned');
    if(!wrap) return;
    wrap.innerHTML = '';
    PINNED.forEach((pkg, idx)=>{
      const div = document.createElement('div');
      div.className = 'pcard';
      const lines = pkg.items.map(it=>`${it.qty||1}√ó ${it.name}`).join('<br>');
      const later = packageTotal(pkg).toFixed(2);
      const first6 = packageFirst6(pkg).toFixed(2);
      const maxIntro = Math.max(0, ...pkg.items.map(it=>{ const pp = plans.find(x=>x.name===it.name); return pp && pp.introMonths ? pp.introMonths : 0; }));
      div.innerHTML = `
        <div class="top">
          <div class="ptitle">${pkg.title}</div>
          <button class="del" title="Remove">‚úï</button>
        </div>
        <div class="plist">${lines}</div>
        <div class="prow">
          <div class="ptotal">
            <div class="ptotal">
  <div style="font-weight:800;color:var(--accent)">${maxIntro>0?`1‚Äì${maxIntro}m`:'Total'}: ¬£${first6}</div>
  ${maxIntro>0?`<div class="muted" style="font-size:12px">${maxIntro+1}‚Äì24m: ¬£${later}</div>`:''}
</div>
          <button class="btn">Add package</button>
        </div>`;
      // animation: make pinned cards fade/slide in with a slight stagger
      div.classList.add('appear');
      div.style.animationDelay = (idx*70)+'ms';
      div.querySelector('.btn').addEventListener('click',()=>addPinnedToCart(pkg));
      const delBtn = div.querySelector('.del');
      if(admin){ delBtn.style.display='inline'; }
      delBtn.addEventListener('click', (e)=>{ e.stopPropagation(); PINNED.splice(idx,1); savePinned(); renderPinned(); });
      wrap.appendChild(div);
    });
  }
  function bindPinnedToggle(){
    const btn = document.getElementById('togglePinned');
    const grid = document.getElementById('pinned');
    if(!btn || !grid) return;
    btn.onclick = ()=>{
      const isHidden = grid.style.display==='none';
      grid.style.display = isHidden? 'grid':'none';
      btn.textContent = isHidden? '‚ñº':'‚ñ≤';
    };
  }

  function openPinnedEditor(){
    const ed = document.getElementById('pinnedEditor');
    const ta = document.getElementById('pinnedTextarea');
    ta.value = JSON.stringify(PINNED, null, 2);
    ed.style.display = 'block';
  }
  function closePinnedEditor(){
    const ed = document.getElementById('pinnedEditor');
    ed.style.display = 'none';
  }
  function bindPinnedEditor(){
    const btn = document.getElementById('editPinnedBtn');
    const save = document.getElementById('pinnedSave');
    const cancel = document.getElementById('pinnedCancel');
    const reset = document.getElementById('pinnedReset');
    if(btn){ btn.onclick = ()=>openPinnedEditor(); }
    if(cancel){ cancel.onclick = ()=>closePinnedEditor(); }
    if(reset){ reset.onclick = ()=>{ localStorage.removeItem('pinnedPackages'); closePinnedEditor(); } }
    if(save){
      save.onclick = ()=>{
        try{
          const ta = document.getElementById('pinnedTextarea');
          const parsed = JSON.parse(ta.value);
          if(!Array.isArray(parsed)) throw new Error('Expected an array');
          for(const pkg of parsed){
            if(typeof pkg.title!== 'string' || !Array.isArray(pkg.items)) throw new Error('Each package needs a title and items[]');
          }
          PINNED = parsed;
          savePinned();
          renderPinned();
          closePinnedEditor();
        }catch(err){ alert('Invalid JSON: '+ err.message); }
      };
    }
  }

  function bindPinFromCart(){
    const btn = document.getElementById('newPinnedFromCart');
    if(!btn) return;
    btn.onclick = ()=>{
      if(!packageItems.length){ alert('Cart is empty. Add some tariffs first, then pin.'); return; }
      const title = prompt('Package title');
      if(title===null) return;
      const items = packageItems.map(it=>({ name: it.name, qty: it.qty }));
      PINNED.unshift({ title: title || 'Pinned package', items });
      savePinned();
      renderPinned();
    };
  }

  function bindExportPinned(){
    const btn = document.getElementById('exportPinnedJson');
    if(!btn) return;
    btn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(PINNED, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'pinned.json'; a.click();
      URL.revokeObjectURL(url);
    };
  }

  const plans = [
    // 25GB
    P({name:"25GB Lite SIMO 24M", tier:"Lite", data:"25GB", price:7.00, inc:["¬£14.00 from Mar26","¬£15.25 from Apr26","¬£16.50 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"25GB Value SIMO 24M", tier:"Value", data:"25GB", price:9.50, inc:["¬£10.12 from Apr26","¬£20.25 from Jun26","¬£21.50 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"25GB Complete SIMO 24M", tier:"Complete", data:"25GB", price:12.00, inc:["¬£12.62 from Apr26","¬£25.25 from Sep26","¬£26.50 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),

    // 120GB
    P({name:"120GB Lite SIMO 24M", tier:"Lite", data:"120GB", price:8.00, inc:["¬£16.00 from Mar26","¬£17.50 from Apr26","¬£19.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"120GB Value SIMO 24M", tier:"Value", data:"120GB", price:10.50, inc:["¬£11.25 from Apr26","¬£22.50 from Jun26","¬£24.00 from Apr27"], features:["Three+ Rewards","5G at no extra cost","Paramount+: 12m inclusive","Go Roam ‚Äì Check plan details"]}),
    P({name:"120GB Complete SIMO 24M", tier:"Complete", data:"120GB", price:13.00, inc:["¬£13.75 from Apr26","¬£27.50 from Sep26","¬£29.00 from Apr27"], features:["5G at no extra cost","Go Roam ‚Äì Check plan details","Three+ Rewards","Paramount+: 24m inclusive"]}),

    // 160GB main
    P({name:"160GB Lite SIMO 24M", tier:"Lite", data:"160GB", price:22.00, inc:["¬£23.50 from Apr26","¬£25.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Value SIMO 24M", tier:"Value", data:"160GB", price:27.00, inc:["¬£28.50 from Apr26","¬£30.00 from Apr27"], features:["Three+ Rewards","5G at no extra cost","Paramount+: 12m inclusive","Go Roam ‚Äì Check plan details"]}),
    P({name:"160GB Complete SIMO 24M", tier:"Complete", data:"160GB", price:32.00, inc:["¬£33.50 from Apr26","¬£35.00 from Apr27"], features:["5G at no extra cost","Go Roam ‚Äì Check plan details","Three+ Rewards","Paramount+: 24m inclusive"]}),

    // 160GB variants (X / Multi)
    P({name:"160GB Value SIMO 24M X", tier:"Value", data:"160GB", price:16.80, x:true, inc:["¬£18.30 from Apr26","¬£19.80 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Complete SIMO Multi SIM 24M", tier:"Complete", data:"160GB", price:20.00, multi:true, inc:["¬£21.50 from Apr26","¬£23.00 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Complete SIMO 24M X", tier:"Complete", data:"160GB", price:20.80, x:true, inc:["¬£22.30 from Apr26","¬£23.80 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Lite SIMO Multi SIM 24M", tier:"Lite", data:"160GB", price:10.00, multi:true, inc:["¬£11.50 from Apr26","¬£13.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Lite SIMO 24M X", tier:"Lite", data:"160GB", price:12.80, x:true, inc:["¬£14.30 from Apr26","¬£15.80 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"160GB Value SIMO Multi SIM 24M", tier:"Value", data:"160GB", price:15.00, multi:true, inc:["¬£16.50 from Apr26","¬£18.00 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),

    // 250GB
    P({name:"250GB Complete SIMO 24M", tier:"Complete", data:"250GB", price:16.00, inc:["¬£16.75 from Apr26","¬£33.50 from Sep26","¬£35.00 from Apr27"], features:["Three+ Rewards","Go Roam ‚Äì Check plan details","Paramount+: 24m inclusive","5G at no extra cost"]}),
    P({name:"250GB Lite SIMO 24M X", tier:"Lite", data:"250GB", price:12.00, x:true, inc:["¬£13.50 from Apr26","¬£15.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"250GB Lite SIMO 24M", tier:"Lite", data:"250GB", price:11.00, inc:["¬£22.00 from Mar26","¬£23.50 from Apr26","¬£25.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"250GB Value SIMO 24M", tier:"Value", data:"250GB", price:13.50, inc:["¬£14.25 from Apr26","¬£28.50 from Jun26","¬£30.00 from Apr27"], features:["5G at no extra cost","Paramount+: 12m inclusive","Three+ Rewards","Go Roam ‚Äì Check plan details"]}),

    // Unlimited main
    P({name:"Unlimited Lite SIMO 24M", tier:"Lite", data:"Unlimited", price:13.50, inc:["¬£27.00 from Mar26","¬£28.50 from Apr26","¬£30.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Value SIMO 24M", tier:"Value", data:"Unlimited", price:32.00, inc:["¬£33.50 from Apr26","¬£35.00 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Complete SIMO 24M", tier:"Complete", data:"Unlimited", price:37.00, inc:["¬£38.50 from Apr26","¬£40.00 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),

    // Unlimited variants (X / S / Multi)
    P({name:"Unlimited Value SIMO 24M X", tier:"Value", data:"Unlimited", price:19.00, x:true, inc:["¬£20.50 from Apr26","¬£22.00 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Complete SIMO 24M S", tier:"Complete", data:"Unlimited", price:20.80, student:true, inc:["¬£22.30 from Apr26","¬£23.80 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Complete SIMO 24M X", tier:"Complete", data:"Unlimited", price:22.00, x:true, inc:["¬£23.50 from Apr26","¬£25.00 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Lite SIMO 24M S", tier:"Lite", data:"Unlimited", price:16.00, student:true, inc:["¬£17.50 from Apr26","¬£19.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Value SIMO 24M S", tier:"Value", data:"Unlimited", price:18.40, student:true, inc:["¬£19.90 from Apr26","¬£21.40 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"MultiSIM Unlimited Complete 24M", tier:"Complete", data:"Unlimited", price:19.00, multi:true, inc:["¬£20.50 from Apr26","¬£22.00 from Apr27"], features:["Paramount+: 24m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"MultiSIM Unlimited Lite 24M", tier:"Lite", data:"Unlimited", price:13.00, multi:true, inc:["¬£14.50 from Apr26","¬£16.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards","50% Off for 24 Months"]}),
    P({name:"MultiSIM Unlimited Value 24M", tier:"Value", data:"Unlimited", price:16.00, multi:true, inc:["¬£17.50 from Apr26","¬£19.00 from Apr27"], features:["Paramount+: 12m inclusive","Go Roam ‚Äì Check plan details","5G at no extra cost","Three+ Rewards"]}),
    P({name:"Unlimited Lite SIMO 24M X", tier:"Lite", data:"Unlimited", price:16.00, x:true, inc:["¬£17.50 from Apr26","¬£19.00 from Apr27"], features:["5G at no extra cost","Three+ Rewards"]}),
  ];

  function P(obj){
    return {id:crypto.randomUUID(), ...obj};
  }

  // Load any saved price overrides
  const saved = JSON.parse(localStorage.getItem('priceOverrides')||'{}');
  for(const [id,price] of Object.entries(saved)){
    const p = plans.find(x=>x.id===id);
    if(p) p.price = price;
  }
  // Load any 6-month half-price flags by plan name
  // Migrate legacy local half6 flags into introMonths=6 (one-way)
const half6ByName = JSON.parse(localStorage.getItem('half6ByName')||'{}');
for(const p of plans){ if(half6ByName[p.name]) p.introMonths = 6; }
// Load new local intro months map (0/6/9/12)
const introByName = JSON.parse(localStorage.getItem('introByName')||'{}');
for(const p of plans){ if(introByName[p.name]) p.introMonths = Number(introByName[p.name])||0; }

  // ‚Äî‚Äî‚Äî UI Render ‚Äî‚Äî‚Äî
  const grid = document.getElementById('grid');
  const cartList = document.getElementById('cartList');
  const grand = document.getElementById('grand');
  let admin=false; let packageItems=[]; let overrideRules = false;

  function render(){
    // filters
    const q = document.getElementById('q').value.trim().toLowerCase();
    const tier = document.getElementById('tier').value;
    const data = document.getElementById('data').value;
    const wantX = document.getElementById('flagX').checked;
    const wantS = document.getElementById('flagS').checked;
    const wantM = document.getElementById('flagMulti').checked;
const introSel = document.getElementById('introSel')?.value || '';

    const filtered = plans.filter(p=>{
      if(q && !(p.name.toLowerCase().includes(q) || p.tier.toLowerCase().includes(q) || p.data.toLowerCase().includes(q))) return false;
      if(tier && p.tier!==tier) return false;
      if(data && p.data!==data) return false;
      if(wantX && !p.x) return false;
      if(wantS && !p.student) return false;
      if(wantM && !p.multi) return false;
      if(introSel){
  const im = p.introMonths || 0;
  if(String(im)!==String(introSel)) return false;
}
      return true;
    });

    grid.innerHTML = '';
    filtered.forEach(p=> grid.appendChild(card(p)) );
    renderPinned();

    // Cart
    cartList.innerHTML='';
    let totalLater=0; // months 7‚Äì24
    let totalFirst6=0; // months 1‚Äì6 with half-price applied where flagged
    packageItems.forEach(it=>{
      const row = document.createElement('div');
      row.className='item';
      row.innerHTML = `<div>
          <div class="name">${it.name}</div>
          ${it.note?`<div class="note">${it.note}</div>`:''}
        </div>
        <div class="qty">
          <button class="btn sec sm qminus" title="Decrease">‚àí</button>
          <input type="number" min="1" value="${it.qty}" />
          <button class="btn sec sm qplus" title="Increase">+</button>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <div>¬£${(it.price*it.qty).toFixed(2)}</div>
          <button class="btn danger" title="Remove">√ó</button>
        </div>`;
      // qty change
      row.querySelector('input').addEventListener('change',e=>{
        it.qty = Math.max(1, Number(e.target.value||1));
        render();
      });
      row.querySelector('.qminus').addEventListener('click',()=>{ it.qty = Math.max(1, (it.qty||1)-1); render(); });
      row.querySelector('.qplus').addEventListener('click',()=>{ it.qty = (it.qty||1)+1; render(); });
      // remove
      row.querySelector('button.btn.danger').addEventListener('click',()=>{
        packageItems = packageItems.filter(x=>x!==it);
        render();
      });
      // Swipe to remove (mobile)
      let sx = null, sy = null;
      row.addEventListener('touchstart', (e)=>{
        if(e.touches && e.touches[0]){ sx = e.touches[0].clientX; sy = e.touches[0].clientY; }
      }, {passive:true});
      row.addEventListener('touchend', (e)=>{
        if(sx===null) return;
        const t = (e.changedTouches && e.changedTouches[0]) || null;
        if(!t) return; const dx = t.clientX - sx; const dy = t.clientY - sy; sx = sy = null;
        if(Math.abs(dx) > 60 && Math.abs(dy) < 30){ // horizontal swipe
          packageItems = packageItems.filter(x=>x!==it);
          render();
        }
      });
      cartList.appendChild(row);
      const plan = plans.find(p=>p.name===it.name);
      const base = it.price*it.qty;
      const isIntro = (plan && plan.introMonths>0);
      const laterAdd = isIntro ? (base*2) : base;
      totalLater += laterAdd;
      const first6 = base; // intro period uses stored (half) price
      totalFirst6 += first6;
    });
    const maxIntro = packageItems.reduce((m,it)=>{
  const plan = plans.find(p=>p.name===it.name);
  const n = plan ? (plan.introMonths||0) : 0;
  return Math.max(m,n);
}, 0);
// Update small cart summary line under the title
const summaryEl = document.getElementById('cartSummary');
if (summaryEl) {
  if (maxIntro > 0) {
    summaryEl.textContent = `Intro ¬£${totalFirst6.toFixed(2)} ‚Üí Later ¬£${totalLater.toFixed(2)}`;
  } else {
    summaryEl.textContent = '';
    // Update rules note for override
    const rn = document.getElementById('rulesNote');
    if(rn){
      rn.textContent = overrideRules
        ? 'Override ACTIVE: Multi‚ÄëSIM and X rules are bypassed for existing customers.'
        : 'Rules enforced: (1) Multi‚ÄëSIM must be ‚â§ highest data in package. (2) Cross‚Äësell/X requires at least one non‚ÄëMulti, non‚ÄëX base plan.';
    }
  }
}
    const rowFirst = document.getElementById('rowFirst6');
    const rowLater = document.getElementById('rowLater');
    const labelFirst = document.getElementById('labelFirst6');
    const labelLater = document.getElementById('labelLater');
    const gFirst = document.getElementById('grandFirst6');
    const gLater = document.getElementById('grandLater');

    if(maxIntro>0){
      if(rowFirst) rowFirst.style.display = '';
      if(labelFirst) labelFirst.textContent = `Months 1‚Äì${maxIntro} per month`;
      if(labelLater) labelLater.textContent = `Months ${maxIntro+1}‚Äì24 per month`;
      if(gFirst) gFirst.textContent = `¬£${totalFirst6.toFixed(2)}`;
      if(gLater) gLater.textContent = `¬£${totalLater.toFixed(2)}`;
    }else{
      if(rowFirst) rowFirst.style.display = 'none';
      if(labelLater) labelLater.textContent = 'Total per month';
      if(gLater) gLater.textContent = `¬£${totalLater.toFixed(2)}`;
    }
    // Savings badge for intro period
    const sEl = document.getElementById('cartSavings');
    if(sEl){
      if(maxIntro>0){
        const savePerMonth = Math.max(0, totalLater - totalFirst6);
        const saveTotal = savePerMonth * maxIntro;
        sEl.textContent = `Save ¬£${saveTotal.toFixed(2)} over first ${maxIntro} months`;
        sEl.style.display = 'inline-block';
      }else{
        sEl.style.display = 'none';
      }
    }
    // Effective average over 24 months
    const avgEl = document.getElementById('avg24');
    if(avgEl){
      if(packageItems.length===0){ avgEl.textContent = '¬£0.00'; }
      else if(maxIntro>0){
        const eff = ((totalFirst6 * maxIntro) + (totalLater * (24 - maxIntro))) / 24;
        avgEl.textContent = `¬£${eff.toFixed(2)}`;
      }else{
        avgEl.textContent = `¬£${totalLater.toFixed(2)}`;
      }
    }
    // Mobile footer
    const mb = document.getElementById('mobileBar');
    const mbFirst = document.getElementById('mFirst6')?.parentElement;
    const mbLater = document.getElementById('mLater')?.parentElement;
    if(mb && mbFirst && mbLater){
      if(maxIntro>0){
        mbFirst.style.display = '';
        // Update both period labels
        mbFirst.querySelector('span').textContent = `1‚Äì${maxIntro}m`;
        mbLater.querySelector('span').textContent = `${maxIntro+1}‚Äì24m`;
        // Update values
        document.getElementById('mFirst6').textContent = `¬£${totalFirst6.toFixed(2)}`;
        document.getElementById('mLater').textContent = `¬£${totalLater.toFixed(2)}`;
      }else{
        mbFirst.style.display = 'none';
        mbLater.querySelector('span').textContent = 'Total';
        document.getElementById('mLater').textContent = `¬£${totalLater.toFixed(2)}`;
      }
    }
  }

  function card(p){
    const el = document.createElement('div');
    el.className='card';
    const flags = [];
    if(p.multi) flags.push('<span class="tag multi">Multi‚ÄëSIM</span>');
    if(p.x) flags.push('<span class="tag x">X</span>');
    if(p.student) flags.push('<span class="tag student">Student</span>');
    if(p.introMonths>0) flags.push(`<span class="tag half">Intro ${p.introMonths}m 1/2</span>`);

    const priceField = admin ? `<input class="editable" type="number" step="0.01" value="${p.price}" style="width:110px;padding:8px;border-radius:8px;color:var(--ink)" />`
                             : `<span class="price">¬£${p.price.toFixed(2)}</span>`;

    el.innerHTML = `
      <div class="tags">${flags.join('')}</div>
      <h3>${p.name}</h3>
      <div class="muted">Data: <b>${p.data}</b> ‚Ä¢ Tier: <b>${p.tier}</b></div>
      <div>From ${priceField} /month</div>
      ${p.introMonths>0 ? `<div class="save">Save ¬£${p.price.toFixed(2)} for ${p.introMonths}m</div>` : ''}
      <div style="display:flex;gap:8px;margin-top:auto">
        <button class="btn">Add</button>
        <button class="btn sec" title="Add & duplicate">Add √ó2</button>
      </div>
      <div class="muted" data-admin="intro" style="display:none">
  <label style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
    Intro half price:
    <select data-intro-sel>
      <option value="0" ${!p.introMonths?'selected':''}>None</option>
      <option value="6" ${p.introMonths===6?'selected':''}>6m</option>
      <option value="9" ${p.introMonths===9?'selected':''}>9m</option>
      <option value="12" ${p.introMonths===12?'selected':''}>12m</option>
    </select>
  </label>
</div>
    `;

    // Admin live price edit
    if(admin){
      const input = el.querySelector('input[type="number"]');
      input.addEventListener('change',e=>{
        const val = Number(e.target.value||0);
        if(!isNaN(val) && val>0){
          p.price = val;
          const overrides = JSON.parse(localStorage.getItem('priceOverrides')||'{}');
          overrides[p.id]=val; localStorage.setItem('priceOverrides',JSON.stringify(overrides));
          render();
        }
      });
    }

    // Admin: set intro half-price months (0/6/9/12)
const adminRow = el.querySelector('[data-admin="intro"]');
if (admin && adminRow) {
  adminRow.style.display = 'block';
  const sel = adminRow.querySelector('[data-intro-sel]');
  sel.addEventListener('change',(e)=>{
    p.introMonths = Number(e.target.value||0);
    const map = JSON.parse(localStorage.getItem('introByName')||'{}');
    if (p.introMonths>0) map[p.name]=p.introMonths; else delete map[p.name];
    localStorage.setItem('introByName', JSON.stringify(map));
    render();
  });
}

    const add = (qty)=>{
      const ok = canAdd(p);
      if(!ok.allowed){
        alert(ok.reason);
        return;
      }
      const existing = packageItems.find(x=>x.id===p.id);
      if(existing) existing.qty += qty; else packageItems.push({id:p.id,name:p.name,price:p.price,qty, note:noteFor(p)});
      render();
    }
    // Card click for plan details (not buttons)
    el.addEventListener('click', function(e){
      if(e.target.closest('button')) return;
      showDetails(p);
    });
    el.querySelector('.btn').addEventListener('click',e=>{e.stopPropagation();add(1)});
    el.querySelector('.btn.sec').addEventListener('click',e=>{e.stopPropagation();add(2)});
    return el;
  }

  function showDetails(p){
    const details = document.getElementById('details');
    const panel = details.closest('.details');
    if(panel && panel.style.display==='none'){ panel.style.display='block'; }
    details.innerHTML = `
      <div style="font-size:16px;font-weight:600;margin-bottom:2px">${p.name}</div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:8px">Tier: <b>${p.tier}</b> ‚Ä¢ Data: <b>${p.data}</b></div>
      <div style="margin-bottom:8px"><b>Price:</b> ¬£${p.price.toFixed(2)} /month</div>
      <div style="margin-bottom:8px"><b>Price increases:</b> ${p.inc ? p.inc.join(' ‚Üí ') : 'None'}</div>
      <div><b>Features:</b></div>
      <ul>
        ${p.features.map(f=>`<li>${f}</li>`).join('')}
      </ul>
    `;
    details.closest('.details').scrollIntoView({behavior:'smooth',block:'start'});
  }

  function dataRank(val){ // to compare data amounts
    if(val==='Unlimited') return 10_000; // arbitrarily huge
    return Number(val.replace('GB',''));
  }

  function hasBase(){
    return packageItems.some(x=>!/Multi| 24M X|X$/.test(x.name) && !/Multi/.test(x.name) && !/ X/.test(x.name));
  }

  function highestData(){
    let max=0;
    for(const it of packageItems){
      const match = it.name.match(/(\d+GB|Unlimited)/);
      if(match) max = Math.max(max, dataRank(match[1]));
    }
    return max;
  }

  function canAdd(p){
    if(overrideRules) return {allowed:true};
    if(p.multi){
      const baseMax = highestData();
      if(!hasBase()) return {allowed:false, reason:'Add a base SIM plan first before Multi‚ÄëSIM.'};
      if(dataRank(p.data) > baseMax) return {allowed:false, reason:'Multi‚ÄëSIM must be same or lower data than your highest base plan.'};
    }
    if(p.x){
      if(!hasBase()) return {allowed:false, reason:'Cross‚Äësell (X) must be added on top of a base SIM plan.'};
    }
    return {allowed:true};
  }

  function noteFor(p){
    if(p.multi) return 'Multi‚ÄëSIM add‚Äëon';
    if(p.x) return 'Cross‚Äësell add‚Äëon';
    if(p.student) return 'Student tariff';
    if(p.introMonths>0) return `${p.introMonths} months half price`;
    return '';
  }

// controls
['q','tier','data','flagX','flagS','flagMulti','introSel'].forEach(id=> document.getElementById(id)?.addEventListener('input',render));
  document.getElementById('resetFilters')?.addEventListener('click', ()=>{
    document.getElementById('q').value = '';
    document.getElementById('tier').value = '';
    document.getElementById('data').value = '';
    document.getElementById('flagX').checked = false;
    document.getElementById('flagS').checked = false;
    document.getElementById('flagMulti').checked = false;
    const is = document.getElementById('introSel'); if(is) is.value = '';
    render();
  });
  document.getElementById('mClear')?.addEventListener('click', ()=>{ packageItems=[]; render(); });
  document.getElementById('clearBtnCart')?.addEventListener('click', ()=>{ packageItems=[]; render(); });
  document.getElementById('exportBtn').addEventListener('click',()=>{
    // recompute totals for export (supports introMonths 6/9/12 and legacy half6)
    let totalLater=0, totalFirst=0;
    const maxIntro = packageItems.reduce((m,it)=>{
      const plan = plans.find(p=>p.name===it.name);
      const n = plan ? (plan.introMonths || (plan.half6?6:0) || 0) : 0;
      return Math.max(m,n);
    }, 0);
    for(const it of packageItems){
      const plan = plans.find(p=>p.name===it.name);
      const base = it.price*it.qty;
      const isIntro = !!(plan && (plan.introMonths>0 || plan.half6));
      totalLater += isIntro ? (base*2) : base; // post-intro months use double
      totalFirst += base;                      // intro months use stored (half) price
    }
    const lines = packageItems.map(it=>`${it.qty} √ó ${it.name} ‚Äî ¬£${(it.price*it.qty).toFixed(2)}`);
    if(maxIntro>0){
      lines.push(`Months 1‚Äì${maxIntro} per month: ¬£${totalFirst.toFixed(2)}`);
      lines.push(`Months ${maxIntro+1}‚Äì24 per month: ¬£${totalLater.toFixed(2)}`);
    }else{
      lines.push(`Total per month: ¬£${totalLater.toFixed(2)}`);
    }
    const blob = new Blob([lines.join('\n')],{type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='package.txt'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('loginBtn').addEventListener('click',()=>{
    if(admin){
      admin=false;
      document.getElementById('adminState').style.display='none';
      const ebtn=document.getElementById('editPinnedBtn'); if(ebtn) ebtn.style.display='none';
      const np=document.getElementById('newPinnedFromCart'); if(np) np.style.display='none';
      // const ex=document.getElementById('exportPinnedJson'); if(ex) ex.style.display='none'; // always hidden now
      const eo=document.getElementById('exportOverridesBtn'); if(eo) eo.style.display='none';
      const ro=document.getElementById('reloadOverridesBtn'); if(ro) ro.style.display='none';
      closePinnedEditor();
      render();
      return;
    }
    const pw = prompt('Enter admin password');
    if(pw===ADMIN_PASS){
      admin=true;
      document.getElementById('adminState').style.display='inline';
      const ebtn=document.getElementById('editPinnedBtn'); if(ebtn) ebtn.style.display='inline-block';
      const np=document.getElementById('newPinnedFromCart'); if(np) np.style.display='inline-block';
      // const ex=document.getElementById('exportPinnedJson'); if(ex) ex.style.display='inline-block'; // always hidden now
      const eo=document.getElementById('exportOverridesBtn'); if(eo) eo.style.display='inline-block';
      const ro=document.getElementById('reloadOverridesBtn'); if(ro) ro.style.display='inline-block';
      render();
    }
    else if(pw!==null){ alert('Incorrect password'); }
  });

  function bindFiltersToggle(){
    const btn = document.getElementById('toggleFilters');
    const body = document.getElementById('filtersBody');
    if(!btn || !body) return;
    const set = (open)=>{ body.style.display = open? 'block' : 'none'; btn.textContent = open? '‚ñ≤' : '‚ñº'; };
    // Default: open on desktop, collapsed on mobile
    const isMobile = window.matchMedia('(max-width: 760px)').matches;
    set(!isMobile ? true : false);
    btn.addEventListener('click', ()=>{ set(body.style.display==='none'); });
  }

  console.info("SIM Package Builder running", DESIGN_VERSION);
  bindPinnedEditor();
  bindPinFromCart();
  bindExportPinned();
  bindFiltersToggle();
  function bindExportOverrides(){
    const btn = document.getElementById('exportOverridesBtn');
    if(!btn) return;
    btn.onclick = ()=>{
      const prices = {}; const intro = {};
      plans.forEach(p=>{ prices[p.name] = Number(p.price); if(p.introMonths>0) intro[p.name]=p.introMonths; });
      const payload = { pricesByName: prices, introMonthsByName: intro, half6Names: Object.keys(intro).filter(n=>intro[n]===6) };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='overrides.json'; a.click(); URL.revokeObjectURL(url);
    };
  }
  bindExportOverrides();
  function bindReloadOverrides(){
    const btn = document.getElementById('reloadOverridesBtn');
    if(!btn) return;
    btn.onclick = ()=> loadOverridesFromJSON();
  }
  bindReloadOverrides();
  bindPinnedToggle();
  render();
  // Bind override buttons (desktop cart + mobile footer)
  const obtn = document.getElementById('overrideBtn');
  const mobOv = document.getElementById('mOverride');
  const syncOv = ()=>{
    if(obtn){
      obtn.textContent = `Override rules (existing customer): ${overrideRules?'ON':'OFF'}`;
      obtn.classList.toggle('on', overrideRules);
    }
    if(mobOv){
      mobOv.textContent = `Override: ${overrideRules?'ON':'OFF'}`;
      mobOv.classList.toggle('on', overrideRules);
    }
    const rn = document.getElementById('rulesNote');
    if(rn){
      rn.textContent = overrideRules
        ? 'Override ACTIVE: Multi‚ÄëSIM and X rules are bypassed for existing customers.'
        : 'Rules enforced: (1) Multi‚ÄëSIM must be ‚â§ highest data in package. (2) Cross‚Äësell/X requires at least one non‚ÄëMulti, non‚ÄëX base plan.';
    }
  };
  [obtn, mobOv].forEach(btn=> btn && btn.addEventListener('click', ()=>{
    overrideRules = !overrideRules;
    sessionStorage.setItem('overrideRules', overrideRules? '1':'0');
    syncOv();
    render();
  }));
  // restore from session and sync once
  (function(){ const savedOv = sessionStorage.getItem('overrideRules'); if(savedOv){ overrideRules = (savedOv==='1'); } syncOv(); })();
  function scrollToCart(){
    const cart = document.querySelector('.cart'); if(!cart) return;
    const header = document.querySelector('header');
    const bar = document.getElementById('mobileBar');
    const rect = cart.getBoundingClientRect();
    const headerH = header ? header.offsetHeight : 0;
    const barH = bar && window.matchMedia('(max-width: 900px)').matches ? bar.offsetHeight : 0;
    const pad = 8; // small breathing room
    const top = rect.top + window.scrollY - headerH - pad; // position with header above
    window.scrollTo({ top, behavior: 'smooth' });
  }
  document.getElementById('mScrollCart')?.addEventListener('click', scrollToCart);
  async function updateTimestampFromGitHub(){
    try{
      const resp = await fetch('https://api.github.com/repos/JXHNWACK/1842/commits/main');
      if(!resp.ok) return;
      const data = await resp.json();
      const iso = data.commit.committer.date;
      const dt = new Date(iso);
      const formatted = dt.toLocaleString('en-GB',{ dateStyle:'short', timeStyle:'short' });
      const el = document.getElementById('lastUpdated');
      if(el) el.textContent = "‚Ä¢ last updated " + formatted;
    }catch(e){ console.warn("Could not fetch commit info", e); }
  }
  updateTimestampFromGitHub();


  async function loadChangelog(){
    try{
      const resp = await fetch('https://api.github.com/repos/JXHNWACK/1842/commits/main');
      if(!resp.ok) return;
      const data = await resp.json();
      const list = document.getElementById('changelogList');
      const bar = document.getElementById('changelogBar');
      const close = document.getElementById('changelogClose');
      if(!list || !bar) return;
      // Only show latest commit message and date
      const msg = (data.commit && data.commit.message ? data.commit.message.split('\n')[0] : 'Update');
      const when = new Date(data.commit.committer.date).toLocaleString('en-GB',{ dateStyle:'short', timeStyle:'short' });
      const html = `<div style="margin-right:14px;display:inline-block"><b>${msg}</b> <span style="color:var(--muted)">(${when})</span></div>`;
      list.innerHTML = html;
      bar.style.display = 'block';
      if(close){ close.onclick = ()=> bar.style.display = 'none'; }
      // Auto-hide after 15s on mobile
      if(window.matchMedia('(max-width: 760px)').matches){ setTimeout(()=>{ bar.style.display='none'; }, 15000); }
    }catch(e){ /* ignore */ }
  }
  loadChangelog();
  // ‚Äî‚Äî Welcome overlay ‚Äî‚Äî
  function openWelcome(){
    document.getElementById('welcomeBackdrop').style.display='block';
    document.getElementById('welcome').style.display='flex';
    document.body.classList.add('modal-open');
    setTimeout(()=>{ document.getElementById('welcomeStart')?.focus(); }, 50);
  }
  function closeWelcome(){
    document.getElementById('welcomeBackdrop').style.display='none';
    document.getElementById('welcome').style.display='none';
    document.body.classList.remove('modal-open');
  }
  (function initWelcome(){
    const dismissed = localStorage.getItem('welcomeDismissed')==='1';
    if(!dismissed){ openWelcome(); }
    const startBtn = document.getElementById('welcomeStart');
    const cb = document.getElementById('welcomeDontShow');
    if(startBtn){
      startBtn.addEventListener('click',()=>{
        if(cb && cb.checked){ localStorage.setItem('welcomeDismissed','1'); }
        closeWelcome();
      });
    }
    // Allow clicking backdrop to close
    document.getElementById('welcomeBackdrop')?.addEventListener('click', closeWelcome);
    // ESC to close
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && document.getElementById('welcome').style.display==='flex'){ closeWelcome(); } });
  })();
  </script>
</body>
</html>